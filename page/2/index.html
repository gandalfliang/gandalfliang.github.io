<!DOCTYPE html>
<html lang=zh>
<head>
    <meta charset="utf-8">
    
    <title>gandalfliang的个人博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta property="og:type" content="website">
<meta property="og:title" content="gandalfliang的个人博客">
<meta property="og:url" content="https://gandalfliang.github.io/page/2/index.html">
<meta property="og:site_name" content="gandalfliang的个人博客">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="gandalfliang的个人博客">
    

    
        <link rel="alternate" href="/atom.xml" title="gandalfliang的个人博客" type="application/atom+xml" />
    

    
        <link rel="icon" href="/avatar.png" />
    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    
    


</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">gandalfliang的个人博客</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
                    <a class="main-nav-link" href="/categories">Categories</a>
                
                    <a class="main-nav-link" href="/tags">Tags</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="https://avatars3.githubusercontent.com/u/5707551?v=3&amp;s=460" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                    <td><a class="main-nav-link" href="/categories">Categories</a></td>
                
                    <td><a class="main-nav-link" href="/tags">Tags</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="https://avatars3.githubusercontent.com/u/5707551?v=3&amp;s=460" />
            <h2 id="name">Gandalfliang</h2>
            <h3 id="title">gandalfliang@outlook.com</h3>
            <span id="location"><i class="fa fa-map-marker"></i>Guangzhou, China, 单身</span>
            <!-- <a id="follow" target="_blank" href="undefined">关注我</a> -->
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                23
                <span>文章</span>
            </div>
            <div class="article-info-block">
                41
                <span>标签</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="http://github.com/gandalfliang" target="_blank" title="github" class=tooltip>
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/atom.xml" target="_blank" title="rss" class=tooltip>
                            <i class="fa fa-rss"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main">
    <article id="post-gaussian_blur_opencl" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2018/01/02/gaussian_blur_opencl/">使用 OpenCL 实现图片高斯模糊</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2018/01/02/gaussian_blur_opencl/">
            <time datetime="2018-01-02T05:58:27.000Z" itemprop="datePublished">2018-01-02</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/技术/">技术</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/OpenCL/">OpenCL</a>, <a class="tag-link" href="/tags/图像处理/">图像处理</a>, <a class="tag-link" href="/tags/高性能计算/">高性能计算</a>, <a class="tag-link" href="/tags/高斯模糊/">高斯模糊</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>高斯模糊（ <a href="https://zh.wikipedia.org/wiki/%E9%AB%98%E6%96%AF%E6%A8%A1%E7%B3%8A" target="_blank" rel="external">https://zh.wikipedia.org/wiki/%E9%AB%98%E6%96%AF%E6%A8%A1%E7%B3%8A</a> ）是一种常见的图像处理算法，使用高斯分布与图像做卷积，得到模糊的效果。其二维定义：<br><img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/c36071d89adc2f4da470b45ce05c33ca93744577" alt=""> </p>
<p>σ是正态分布的标准偏差。在应用的时候，假设σ为2.5。对于模糊半径为1，则高斯矩阵为3*3的一个矩阵，以[1,1]为中心，带入公式计算高斯矩阵的值，得到：  </p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>0.0216996633</td>
<td>0.0235069655</td>
<td>0.0216996633  </td>
</tr>
<tr>
<td>0.0235069655</td>
<td>0.0254647918</td>
<td>0.0235069655  </td>
</tr>
<tr>
<td>0.0216996633</td>
<td>0.0235069655</td>
<td>0.0216996633  </td>
</tr>
</tbody>
</table>
<p>他们的和为 0.206291318，我们需要他们的和为1，因此与总和相除得到：  </p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>0.105189413</td>
<td>0.113950342</td>
<td>0.105189413  </td>
</tr>
<tr>
<td>0.113950342</td>
<td>0.123440929</td>
<td>0.113950342  </td>
</tr>
<tr>
<td>0.105189413</td>
<td>0.113950342</td>
<td>0.105189413  </td>
</tr>
</tbody>
</table>
<p>根据这个矩阵，对图像的每个像素点进行计算，计算的九个点的各rgb分量之和就是最终像素的rgb分量。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//计算高斯矩阵</span></div><div class="line">private <span class="keyword">void</span> ComputeWeightMatrix()</div><div class="line">&#123;</div><div class="line">    <span class="keyword">var</span> center = Radius;</div><div class="line">    <span class="keyword">var</span> conBase = <span class="number">2</span> * <span class="built_in">Math</span>.Pow(Variance, <span class="number">2</span>);</div><div class="line">    <span class="keyword">var</span> conRoot = <span class="number">1</span> / (<span class="built_in">Math</span>.PI * conBase);</div><div class="line"></div><div class="line">    float sum = <span class="number">0</span>f;</div><div class="line">    <span class="keyword">for</span> (int x = -Radius; x &lt;= Radius; x++)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">for</span> (int y = Radius; y &gt;= -Radius; y--)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">var</span> weight = conRoot * <span class="built_in">Math</span>.Pow(<span class="built_in">Math</span>.E, -(x * x + y * y) / conBase);</div><div class="line">            _matrix[GridPosToArrayIndex(x, y, center, Radius)] = (float)weight;</div><div class="line">            sum += (float)weight;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; _matrix.Length; i++)</div><div class="line">    &#123;</div><div class="line">        _matrix[i] /= sum;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//Compute</span></div><div class="line">public <span class="keyword">void</span> Compute(string imageFile)</div><div class="line">&#123;</div><div class="line">    using (<span class="keyword">var</span> bitmap = <span class="keyword">new</span> Bitmap(imageFile))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">var</span> datas = bitmap.LockBits(<span class="keyword">new</span> Rectangle(<span class="keyword">new</span> Point(), <span class="keyword">new</span> Size(bitmap.Width, bitmap.Height)),ImageLockMode.ReadOnly,bitmap.PixelFormat);</div><div class="line">        <span class="keyword">var</span> dataSize = datas.Stride * datas.Height;</div><div class="line">        <span class="keyword">var</span> argbs = <span class="keyword">new</span> byte[dataSize];</div><div class="line">        <span class="keyword">var</span> dsts = <span class="keyword">new</span> byte[dataSize];</div><div class="line">        int matrixWidth = Radius * <span class="number">2</span> + <span class="number">1</span>;</div><div class="line">        Marshal.Copy(datas.Scan0, argbs, <span class="number">0</span>, dataSize);</div><div class="line"></div><div class="line">        Stopwatch sw=Stopwatch.StartNew();</div><div class="line">        <span class="keyword">for</span> (int y = <span class="number">0</span>; y &lt; bitmap.Height; y++)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">for</span> (int x = <span class="number">0</span>; x &lt; bitmap.Width; x++)</div><div class="line">            &#123;</div><div class="line">                float sumA = <span class="number">0</span>;</div><div class="line">                float sumR = <span class="number">0</span>;</div><div class="line">                float sumG = <span class="number">0</span>;</div><div class="line">                float sumB=<span class="number">0</span>;</div><div class="line">                <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; _matrix.Length; i++)</div><div class="line">                &#123;</div><div class="line">                    <span class="keyword">var</span> pos = transform_pos(x, y, matrixWidth, bitmap.Width, bitmap.Height, Radius, i);</div><div class="line">                    <span class="keyword">var</span> position = pos.Y * datas.Stride + pos.X*<span class="number">4</span>;</div><div class="line">                    sumR += argbs[position] * _matrix[i];</div><div class="line">                    sumG += argbs[position + <span class="number">1</span>] * _matrix[i];</div><div class="line">                    sumB += argbs[position + <span class="number">2</span>] * _matrix[i];</div><div class="line">                    sumA += argbs[position + <span class="number">3</span>] * _matrix[i];</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">var</span> dstPos = y * datas.Stride + x * <span class="number">4</span>;</div><div class="line">                dsts[dstPos] = (byte)sumR;</div><div class="line">                dsts[dstPos+<span class="number">1</span>] = (byte)sumG;</div><div class="line">                dsts[dstPos+<span class="number">2</span>] = (byte)sumB;</div><div class="line">                dsts[dstPos+<span class="number">3</span>] = (byte)sumA;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        bitmap.UnlockBits(datas);</div><div class="line"></div><div class="line">        <span class="keyword">var</span> elapse = sw.Elapsed;</div><div class="line">        Console.WriteLine($<span class="string">"Costing: &#123;elapse&#125;"</span>);</div><div class="line">        Debug.WriteLine($<span class="string">"Costing: &#123;elapse&#125;"</span>);</div><div class="line"></div><div class="line">        <span class="keyword">var</span> handle = GCHandle.Alloc(dsts, GCHandleType.Pinned);</div><div class="line">        using (<span class="keyword">var</span> dstBmp = <span class="keyword">new</span> Bitmap(datas.Width, datas.Height, datas.Stride, bitmap.PixelFormat,</div><div class="line">            handle.AddrOfPinnedObject()))</div><div class="line">        &#123;</div><div class="line">            dstBmp.Save(<span class="string">"processed_normal.bmp"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        handle.Free();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>当然，这样能完成工作，但是耗时太长，对于3000*1920尺寸的图片处理需要2分51秒（Intel Core i7-4770)，这显然是不可接受的。<br>对于这种分别计算每个像素，且各像素间互不干扰的问题，使用OpenCL可以大幅降低时间消耗。  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">    OpenCL 高斯模糊代码</div><div class="line">    Copyright Gandalfliang</div><div class="line">*/ </div><div class="line">inline int2 transform_pos(int centerX,int centerY,int matrixWidth,int radius,int index)</div><div class="line">&#123;</div><div class="line">    int x=index%matrixWidth;</div><div class="line">    int offsetX=x-(radius+<span class="number">1</span>);</div><div class="line">    int y=index/matrixWidth;</div><div class="line">    int offsetY=radius-y;</div><div class="line">    <span class="keyword">return</span> (int2)(centerX+offsetX,centerY-offsetY);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">const</span> sampler_t sampler_img=CLK_NORMALIZED_COORDS_FALSE|CLK_ADDRESS_CLAMP_TO_EDGE;</div><div class="line"></div><div class="line"><span class="comment">//opencl kernel 代码</span></div><div class="line">kernel <span class="keyword">void</span> gaussian_blur(</div><div class="line">    read_only image2d_t src,</div><div class="line">    global write_only char* dst,</div><div class="line">    global read_only float* matrix,</div><div class="line">    read_only int radius,</div><div class="line">	read_only int width)</div><div class="line">&#123;</div><div class="line">    int x=get_global_id(<span class="number">0</span>);</div><div class="line">    int y=get_global_id(<span class="number">1</span>);</div><div class="line"></div><div class="line">    float sumR,sumG,sumB,sumA;</div><div class="line">    int matrixWidth=radius*<span class="number">2</span>+<span class="number">1</span>;</div><div class="line">    int matrix_size=pow(matrixWidth,<span class="number">2</span>);</div><div class="line">    <span class="keyword">for</span>(int i=<span class="number">0</span>;i&lt;matrix_size;i++)</div><div class="line">    &#123;</div><div class="line">        int2 pix=transform_pos(x,y,matrixWidth,radius,i);</div><div class="line">        uint4 rgba = read_imageui(src,sampler_img,pix);</div><div class="line">        sumR+=rgba.x*matrix[i];</div><div class="line">        sumG+=rgba.y*matrix[i];</div><div class="line">        sumB+=rgba.z*matrix[i];</div><div class="line">		sumA+=rgba.w*matrix[i];</div><div class="line">    &#125;</div><div class="line">   </div><div class="line">	int loc=y*width*<span class="number">4</span>+x*<span class="number">4</span>;</div><div class="line">	dst[loc]=sumR;</div><div class="line">	dst[loc+<span class="number">1</span>]=sumG;</div><div class="line">	dst[loc+<span class="number">2</span>]=sumB;</div><div class="line">	dst[loc+<span class="number">3</span>]=sumA;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Host代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">public <span class="keyword">void</span> Compute_cl(string imageFile)</div><div class="line">&#123;</div><div class="line">    <span class="comment">//选取设备</span></div><div class="line">    <span class="keyword">var</span> platform = ComputePlatform.Platforms.FirstOrDefault();</div><div class="line">    <span class="keyword">var</span> device = platform.Devices.FirstOrDefault();</div><div class="line">    <span class="comment">//设置相关上下文</span></div><div class="line">    <span class="keyword">var</span> properties = <span class="keyword">new</span> ComputeContextPropertyList(platform);</div><div class="line">    <span class="keyword">var</span> context = <span class="keyword">new</span> ComputeContext(<span class="keyword">new</span>[] &#123;device&#125;, properties, <span class="literal">null</span>, IntPtr.Zero);</div><div class="line">    <span class="comment">//命令队列，用于控制执行的代码</span></div><div class="line">    ComputeCommandQueue commands = <span class="keyword">new</span> ComputeCommandQueue(context, context.Devices[<span class="number">0</span>],</div><div class="line">        ComputeCommandQueueFlags.None);</div><div class="line">    <span class="comment">//读取opencl代码</span></div><div class="line">    <span class="keyword">var</span> code = File.ReadAllText(@<span class="string">"gaussianblur.cl"</span>);</div><div class="line">    <span class="comment">//编译</span></div><div class="line">    <span class="keyword">var</span> program = <span class="keyword">new</span> ComputeProgram(context, code);</div><div class="line">    <span class="keyword">try</span></div><div class="line">    &#123;</div><div class="line">        program.Build(<span class="keyword">new</span>[] &#123;device&#125;, <span class="literal">null</span>, <span class="literal">null</span>, IntPtr.Zero);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (Exception ex)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">throw</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> images = CreateImageFromBitmap(imageFile, context,</div><div class="line">        ComputeMemoryFlags.ReadWrite | ComputeMemoryFlags.CopyHostPointer);</div><div class="line"></div><div class="line">    <span class="comment">//创建核心代码，就是cl代码中以kernel标识的函数</span></div><div class="line">    <span class="keyword">var</span> kernel = program.CreateKernel(<span class="string">"gaussian_blur"</span>);</div><div class="line">    <span class="comment">//矩阵规模</span></div><div class="line">    <span class="comment">//储存计算结果的数组</span></div><div class="line">    </div><div class="line">    <span class="comment">//创建的核心代码函数以这种方式来传参</span></div><div class="line">    <span class="keyword">var</span> resultBuffer=<span class="keyword">new</span> ComputeBuffer&lt;char&gt;(context,ComputeMemoryFlags.WriteOnly, dstBytes.Length);</div><div class="line">    kernel.SetMemoryArgument(<span class="number">0</span>, images);</div><div class="line">    kernel.SetMemoryArgument(<span class="number">1</span>, resultBuffer);</div><div class="line">    kernel.SetMemoryArgument(<span class="number">2</span>, <span class="keyword">new</span> ComputeBuffer&lt;float&gt;(context,ComputeMemoryFlags.ReadOnly|ComputeMemoryFlags.CopyHostPointer,_matrix));</div><div class="line">    kernel.SetValueArgument(<span class="number">3</span>, Radius);</div><div class="line">    kernel.SetValueArgument(<span class="number">4</span>, (int)images.Width);</div><div class="line">    Console.WriteLine($<span class="string">"运行平台: &#123;platform.Name&#125;\n运行设备： &#123;device.Name&#125;\n"</span>);</div><div class="line">    Stopwatch sw = Stopwatch.StartNew();</div><div class="line">    <span class="keyword">var</span> climg = images;</div><div class="line"></div><div class="line">    <span class="comment">//执行代码</span></div><div class="line">    commands.Execute(kernel, <span class="literal">null</span>, <span class="keyword">new</span> long[] &#123;climg.Width, climg.Height&#125;, <span class="literal">null</span>, <span class="literal">null</span>);</div><div class="line">    </div><div class="line">    <span class="comment">//read data</span></div><div class="line">    char[] resultArray = <span class="keyword">new</span> char[dstBytes.Length];</div><div class="line">    <span class="keyword">var</span> arrHandle = GCHandle.Alloc(resultArray, GCHandleType.Pinned);</div><div class="line">    commands.Read(resultBuffer, <span class="literal">true</span>, <span class="number">0</span>, dstBytes.Length, arrHandle.AddrOfPinnedObject(), <span class="literal">null</span>);</div><div class="line">    <span class="comment">//commands.ReadFromImage(images.Item2, processeddata.Scan0, true, null);</span></div><div class="line"></div><div class="line">    <span class="keyword">var</span> resultHandle = GCHandle.Alloc(resultArray, GCHandleType.Pinned);</div><div class="line">    <span class="keyword">var</span> bmp=<span class="keyword">new</span> Bitmap(climg.Width,climg.Height, climg.Width*<span class="number">4</span>, PixelFormat.Format32bppArgb, resultHandle.AddrOfPinnedObject());</div><div class="line">    <span class="keyword">var</span> elapsed = sw.Elapsed;</div><div class="line">    Console.WriteLine($<span class="string">"耗时: &#123;elapsed.TotalMilliseconds&#125; ms\n"</span>);</div><div class="line">    kernel.Dispose();</div><div class="line"></div><div class="line">    bmp.Save(<span class="string">"processed_cl.bmp"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>相同尺寸的图片处理，使用 Intel Core i7-4770 自带的核显 HD4600 处理，耗时只需要164毫秒。</p>
<p>以下是相关测试结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">运行平台: Intel(R) OpenCL</div><div class="line">运行设备： Intel(R) HD Graphics 4600</div><div class="line">处理图片尺寸：790*501</div><div class="line">OpenCL处理耗时: 13.6597 ms</div><div class="line"></div><div class="line">处理图片尺寸：790*501</div><div class="line">常规方法耗时: 11482.9402 ms</div><div class="line"></div><div class="line">运行平台: Intel(R) OpenCL</div><div class="line">运行设备： Intel(R) HD Graphics 4600</div><div class="line">处理图片尺寸：1339*693</div><div class="line">OpenCL处理耗时: 33.0095 ms</div><div class="line"></div><div class="line">处理图片尺寸：1339*693</div><div class="line">常规方法耗时: 26908.9926 ms</div><div class="line"></div><div class="line">运行平台: Intel(R) OpenCL</div><div class="line">运行设备： Intel(R) HD Graphics 4600</div><div class="line">处理图片尺寸：1920*1080</div><div class="line">OpenCL处理耗时: 51.3885 ms</div><div class="line"></div><div class="line">处理图片尺寸：1920*1080</div><div class="line">常规方法耗时: 60147.3815 ms</div></pre></td></tr></table></figure></p>
<p>当然，常规方法都只使用了单线程，还未发挥多核CPU的威力，然而，可以预见的是，即使是使用多线程，提升也是有限的。</p>
<p>原图：<br><img src="/2018/01/02/gaussian_blur_opencl/screen_shot_gaus.png" alt="screen_shot_gaus.png" title=""><br>高斯模糊：<br><img src="/2018/01/02/gaussian_blur_opencl/processed_cl.bmp" alt="processed_cl.bmp" title=""></p>
<p>代码： <a href="https://github.com/gandalfliang/cloo_netstandard/tree/temp" target="_blank" rel="external">https://github.com/gandalfliang/cloo_netstandard/tree/temp</a> </p>
<font size="4" color="red">Update: 在nVidia的环境下会导致处理后的图片出现花屏现象，估计是cl代码的问题，又或者是nVidia的驱动有问题？下次再更新</font>
        
        </div>
        <footer class="article-footer">
            <div class="share-container">


    <div class="bdsharebuttonbox">
    <a href="#" class="bds_more" data-cmd="more">分享到：</a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a>    
    <a href="#" class="bds_sqq" data-cmd="qzone" title="分享给QQ好友">QQ</a>
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a>
</div>
<script>
window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"share":{"bdSize":16}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>
<style>
    .bdshare_popup_box {
        border-radius: 4px;
        border: #e1e1e1 solid 1px;
    }
    .bdshare-button-style0-16 a,
    .bdshare-button-style0-16 .bds_more {
        padding-left: 20px;
        margin: 6px 10px 6px 0;
    }
    .bdshare_dialog_list a,
    .bdshare_popup_list a,
    .bdshare_popup_bottom a {
        font-family: 'Microsoft Yahei';
    }
    .bdshare_popup_top {
        display: none;
    }
    .bdshare_popup_bottom {
        height: auto;
        padding: 5px;
    }
</style>


</div>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-cloo_net_standard" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/12/25/cloo_net_standard/">.NET Standard CLOO</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/12/25/cloo_net_standard/">
            <time datetime="2017-12-25T03:01:38.000Z" itemprop="datePublished">2017-12-25</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/技术/">技术</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/CLOO/">CLOO</a>, <a class="tag-link" href="/tags/NET-Standard/">NET Standard</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>鉴于 .NET Standard 2.0 已经支持大量的.NET api，移植CLOO已经是毫无难度的一件事情 <a href="https://github.com/gandalfliang/cloo_netstandard" target="_blank" rel="external">Github</a></p>
<p>CLOO使用p/invoke方式调用opencl api，但是对于不同平台下，opencl 的名称并不一致，例如在linux下为libOpenCL.so，Windows下为OpenCL.dll，且 .NET Standard 没有提供 Mono 类似的 dllmap 模式，因此，现在来说还不能达到用一个package，在所有平台引用的目的。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">


    <div class="bdsharebuttonbox">
    <a href="#" class="bds_more" data-cmd="more">分享到：</a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a>    
    <a href="#" class="bds_sqq" data-cmd="qzone" title="分享给QQ好友">QQ</a>
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a>
</div>
<script>
window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"share":{"bdSize":16}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>
<style>
    .bdshare_popup_box {
        border-radius: 4px;
        border: #e1e1e1 solid 1px;
    }
    .bdshare-button-style0-16 a,
    .bdshare-button-style0-16 .bds_more {
        padding-left: 20px;
        margin: 6px 10px 6px 0;
    }
    .bdshare_dialog_list a,
    .bdshare_popup_list a,
    .bdshare_popup_bottom a {
        font-family: 'Microsoft Yahei';
    }
    .bdshare_popup_top {
        display: none;
    }
    .bdshare_popup_bottom {
        height: auto;
        padding: 5px;
    }
</style>


</div>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-Gitsoler" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/12/16/Gitsoler/">Gitsoler</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/12/16/Gitsoler/">
            <time datetime="2017-12-16T03:01:38.000Z" itemprop="datePublished">2017-12-16</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/工具/">工具</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Extension/">Extension</a>, <a class="tag-link" href="/tags/Visual-Studio/">Visual Studio</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h1 id="Gitsoler-a-Visual-Studio-extension-now-goes-public-https-marketplace-visualstudio-com-items-itemName-gandalfliang-gitsoler"><a href="#Gitsoler-a-Visual-Studio-extension-now-goes-public-https-marketplace-visualstudio-com-items-itemName-gandalfliang-gitsoler" class="headerlink" title="Gitsoler - a Visual Studio extension, now goes public: https://marketplace.visualstudio.com/items?itemName=gandalfliang.gitsoler"></a>Gitsoler - a Visual Studio extension, now goes public: <a href="https://marketplace.visualstudio.com/items?itemName=gandalfliang.gitsoler" target="_blank" rel="external">https://marketplace.visualstudio.com/items?itemName=gandalfliang.gitsoler</a></h1>
        
        </div>
        <footer class="article-footer">
            <div class="share-container">


    <div class="bdsharebuttonbox">
    <a href="#" class="bds_more" data-cmd="more">分享到：</a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a>    
    <a href="#" class="bds_sqq" data-cmd="qzone" title="分享给QQ好友">QQ</a>
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a>
</div>
<script>
window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"share":{"bdSize":16}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>
<style>
    .bdshare_popup_box {
        border-radius: 4px;
        border: #e1e1e1 solid 1px;
    }
    .bdshare-button-style0-16 a,
    .bdshare-button-style0-16 .bds_more {
        padding-left: 20px;
        margin: 6px 10px 6px 0;
    }
    .bdshare_dialog_list a,
    .bdshare_popup_list a,
    .bdshare_popup_bottom a {
        font-family: 'Microsoft Yahei';
    }
    .bdshare_popup_top {
        display: none;
    }
    .bdshare_popup_bottom {
        height: auto;
        padding: 5px;
    }
</style>


</div>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-WPFLostTouchCapability" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/12/02/WPFLostTouchCapability/">“阻断疗法” - 拯救 WPF 启动过程中发生设备热插拔导致触摸失效问题</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/12/02/WPFLostTouchCapability/">
            <time datetime="2017-12-02T05:58:27.000Z" itemprop="datePublished">2017-12-02</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/技术/">技术</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/BUG/">BUG</a>, <a class="tag-link" href="/tags/WPF/">WPF</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>如果你在WPF程序启动过程中进行设备热插拔（例如，插入一个U盘，一个USB摄像头），那么你的WPF程序很有可能失去所有触摸消息响应，通过 Tablet.TabletDevices.Count 检查当前程序的挂靠触摸设备，发现为0。有趣的是，如果你将触摸线重新插拔后，程序恢复正常。所以，这是WPF的Bug，微软的锅。那么这个锅的根本原因是啥？有兴趣的可以调试 .net framework 源码，这里没有深究。<br>如上面讲到，触摸线重新插拔就可以解决这个问题，但是，导致这个问题的热插拔设备也不是触摸设备啊，只是一个普通的U盘，反过来想，如果导致问题的不是触摸设备热插拔，反而触摸设备的热插拔能够修复这个问题，那我能不能“模拟”一下触摸设备的热插拔事件呢？在这篇<a href="https://msdn.microsoft.com/en-us/library/dd901337%28v=vs.90%29.aspx?f=255&amp;MSPPError=-2147217396" target="_blank" rel="external">文章</a>里描述怎样模拟触摸设备移除事件来达到禁用WPF触摸的效果,反过来试试，通过 OnTabletAdded 事件看看能不能发生奇迹。然而，奇迹并没有发生，所以这个方法不行。<br>既然模拟设备添加事件的方法不行，那我从源头阻挡这个问题的发生：启动过程中不要处理设备变动事件。那么问题来了，我想要阻断 win32 WM 事件通知，必须要拿到一个窗口句柄呀，但是在 mainwindow show 出来的时候，这个问题已经发生了，这个时候的阻断已经没有效果了，一定要程序启动一开始做阻断。进一步搜索，这里<a href="https://stackoverflow.com/questions/38642479/how-to-disable-wpf-tablet-support-in-surface-4-pro" target="_blank" rel="external">https://stackoverflow.com/questions/38642479/how-to-disable-wpf-tablet-support-in-surface-4-pro</a> 是一个突破口：  </p>
<blockquote>
<p>WPF does not register to these messages on the applications MainWindow, but through a hidden windows named “SystemResources…” which is created for each application instance. So handling those messages on the MainWindow (which would be easy) does not help here.</p>
</blockquote>
<p>相信看到这里，聪明的你已经知道怎么做了。  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">WPFTouchUtil</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="comment">//添加钩子，阻断设备改动消息</span></div><div class="line">        public <span class="keyword">static</span> <span class="keyword">void</span> HandleDeviceChangedWM()</div><div class="line">        &#123;</div><div class="line">            <span class="comment">// hook into internal class SystemResources to keep it from updating the TabletDevices on system events</span></div><div class="line">            object hwndWrapper = GetSystemResourcesHwnd();</div><div class="line">            <span class="keyword">if</span> (hwndWrapper != <span class="literal">null</span>)</div><div class="line">            &#123;</div><div class="line">                <span class="comment">// invoke hwndWrapper.AddHook( .. our method ..)</span></div><div class="line">                <span class="keyword">var</span> internalHwndWrapperType = hwndWrapper.GetType();</div><div class="line">                <span class="comment">// if the delegate is already set, we have already added the hook.</span></div><div class="line">                <span class="keyword">if</span> (_handleAndHideMessageDelegate == <span class="literal">null</span>)</div><div class="line">                &#123;</div><div class="line">                    <span class="comment">// create the internal delegate that will hook into the window messages</span></div><div class="line">                    <span class="comment">// need to hold a reference to that one, because internally the delegate is stored through a WeakReference object</span></div><div class="line">                    <span class="keyword">var</span> internalHwndWrapperHookDelegate = internalHwndWrapperType.Assembly.GetType(<span class="string">"MS.Win32.HwndWrapperHook"</span>);</div><div class="line">                    <span class="keyword">var</span> handleAndHideMessagesHandle = <span class="keyword">typeof</span>(WPFTouchUtil).GetMethod(nameof(HandleAndHideMessages), BindingFlags.Static | BindingFlags.NonPublic);</div><div class="line">                    _handleAndHideMessageDelegate = Delegate.CreateDelegate(internalHwndWrapperHookDelegate, handleAndHideMessagesHandle);</div><div class="line">                    <span class="comment">// add a delegate that handles WM_TABLET_ADD</span></div><div class="line">                    internalHwndWrapperType.InvokeMember(<span class="string">"AddHook"</span>,</div><div class="line">                        BindingFlags.InvokeMethod | BindingFlags.Instance | BindingFlags.Public,</div><div class="line">                        <span class="literal">null</span>, hwndWrapper, <span class="keyword">new</span> object[] &#123; _handleAndHideMessageDelegate &#125;);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//移除钩子，恢复状态</span></div><div class="line">        public <span class="keyword">static</span> <span class="keyword">void</span> RestoreDeviceChangedWM()</div><div class="line">        &#123;</div><div class="line">            object hwndWrapper = GetSystemResourcesHwnd();</div><div class="line">            <span class="keyword">if</span> (hwndWrapper != <span class="literal">null</span>)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">var</span> internalHwndWrapperType = hwndWrapper.GetType();</div><div class="line"></div><div class="line">                internalHwndWrapperType.InvokeMember(<span class="string">"RemoveHook"</span>,</div><div class="line">                    BindingFlags.InvokeMethod | BindingFlags.Instance | BindingFlags.Public,</div><div class="line">                    <span class="literal">null</span>, hwndWrapper, <span class="keyword">new</span> object[] &#123;_handleAndHideMessageDelegate&#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        private <span class="keyword">static</span> Delegate _handleAndHideMessageDelegate = <span class="literal">null</span>;</div><div class="line"></div><div class="line">        private <span class="keyword">static</span> object GetSystemResourcesHwnd()</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">var</span> internalSystemResourcesType = <span class="keyword">typeof</span>(Application).Assembly.GetType(<span class="string">"System.Windows.SystemResources"</span>);</div><div class="line"></div><div class="line">            <span class="comment">// get HwndWrapper from internal property SystemRessources.Hwnd;</span></div><div class="line">            <span class="keyword">var</span> hwndWrapper = internalSystemResourcesType.InvokeMember(<span class="string">"Hwnd"</span>,</div><div class="line">                        BindingFlags.GetProperty | BindingFlags.Static | BindingFlags.NonPublic,</div><div class="line">                        <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</div><div class="line">            <span class="keyword">return</span> hwndWrapper;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        private <span class="keyword">static</span> IntPtr HandleAndHideMessages(IntPtr hwnd, int msg, IntPtr wParam, IntPtr lParam, ref bool handled)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (msg == (int)WindowMessage.WM_DEVICECHANGE)</div><div class="line">            &#123;</div><div class="line">                handled = <span class="literal">true</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> IntPtr.Zero;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        enum WindowMessage : int</div><div class="line">        &#123;</div><div class="line">            WM_DEVICECHANGE = <span class="number">0x0219</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在程序刚启动的时候添加“阻断”，启动流程过后，不要忘了恢复状态。<br>缺陷，如果程序启动过程中，真的发生了触摸设备变动，也会被阻断。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">


    <div class="bdsharebuttonbox">
    <a href="#" class="bds_more" data-cmd="more">分享到：</a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a>    
    <a href="#" class="bds_sqq" data-cmd="qzone" title="分享给QQ好友">QQ</a>
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a>
</div>
<script>
window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"share":{"bdSize":16}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>
<style>
    .bdshare_popup_box {
        border-radius: 4px;
        border: #e1e1e1 solid 1px;
    }
    .bdshare-button-style0-16 a,
    .bdshare-button-style0-16 .bds_more {
        padding-left: 20px;
        margin: 6px 10px 6px 0;
    }
    .bdshare_dialog_list a,
    .bdshare_popup_list a,
    .bdshare_popup_bottom a {
        font-family: 'Microsoft Yahei';
    }
    .bdshare_popup_top {
        display: none;
    }
    .bdshare_popup_bottom {
        height: auto;
        padding: 5px;
    }
</style>


</div>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-Timelapse2" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/10/20/Timelapse2/">Timelapse#2</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/10/20/Timelapse2/">
            <time datetime="2017-10-20T12:33:39.000Z" itemprop="datePublished">2017-10-20</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/摄影/">摄影</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Guangzhou/">Guangzhou</a>, <a class="tag-link" href="/tags/Nikon/">Nikon</a>, <a class="tag-link" href="/tags/Timelapse/">Timelapse</a>, <a class="tag-link" href="/tags/Video/">Video</a>, <a class="tag-link" href="/tags/单反/">单反</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>Lens: Nikkor 24-70mm F2.8<br>f2.8  70mm  ISO400<br><div class="video-container"><iframe src="//player.vimeo.com/video/gz_timelapse_cold_signature.mp4" frameborder="0" allowfullscreen></iframe></div></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">


    <div class="bdsharebuttonbox">
    <a href="#" class="bds_more" data-cmd="more">分享到：</a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a>    
    <a href="#" class="bds_sqq" data-cmd="qzone" title="分享给QQ好友">QQ</a>
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a>
</div>
<script>
window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"share":{"bdSize":16}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>
<style>
    .bdshare_popup_box {
        border-radius: 4px;
        border: #e1e1e1 solid 1px;
    }
    .bdshare-button-style0-16 a,
    .bdshare-button-style0-16 .bds_more {
        padding-left: 20px;
        margin: 6px 10px 6px 0;
    }
    .bdshare_dialog_list a,
    .bdshare_popup_list a,
    .bdshare_popup_bottom a {
        font-family: 'Microsoft Yahei';
    }
    .bdshare_popup_top {
        display: none;
    }
    .bdshare_popup_bottom {
        height: auto;
        padding: 5px;
    }
</style>


</div>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-WPF_rendering_perf" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/09/20/WPF_rendering_perf/">WPF 渲染小结</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/09/20/WPF_rendering_perf/">
            <time datetime="2017-09-20T04:19:30.000Z" itemprop="datePublished">2017-09-20</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/技术/">技术</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/DirectX/">DirectX</a>, <a class="tag-link" href="/tags/Perforator/">Perforator</a>, <a class="tag-link" href="/tags/Profiling/">Profiling</a>, <a class="tag-link" href="/tags/WPF/">WPF</a>, <a class="tag-link" href="/tags/渲染/">渲染</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>在上一篇文章<a href="https://gandalfliang.github.io/2017/09/11/D3DImageInDepth/">D3DImage - 它能做啥、解决了什么问题、有哪些瓶颈、怎么最佳实践</a>最后，提到DropShadowEffect严重影响到D3DImage的渲染性能问题，导致程序在渲染8分屏（8个远端视频）的时候，出现严重的性能下降，渲染卡顿。要知道，在使用原生窗口渲染方案渲染8分屏，CPU占用和内存占用也不过25%和~200Mb，稍差一点，使用D3DImage优化后方案渲染，CPU占用并没有出现多大的跳跃，大约在30%左右。即使是添加了DropShadowEffect的情况下，CPU占用和内存占用好像都没有多大变化；既然在CPU和内存占用都没有多大变化的情况下，WPF渲染卡顿，那肯定（可能吧）是“帧生成”时间过长的锅。 </p>
<h2 id="帧生成时间"><a href="#帧生成时间" class="headerlink" title="帧生成时间"></a>帧生成时间</h2><p>玩游戏的人都知道，影响游戏帧数的一个关键因素是帧生成时间，帧生成时间过长必定导致游戏FPS下降，游戏不流畅。帧生成时间并不等同帧更新时间，这个需要搞清楚。例如一个游戏锁帧60FPS,那么帧更新时间为1000/60=16.6ms,通常来说，如果你硬件性能足够强劲，那么帧生成时间要小于16.6ms才能保证游戏运行在60FPS的帧率下，否则会掉帧。类似的，WPF的渲染帧率下降可能（无责任猜想）也是同样的因素导致。But why?  </p>
<h2 id="DropShadowEffect-的锅"><a href="#DropShadowEffect-的锅" class="headerlink" title="DropShadowEffect 的锅"></a>DropShadowEffect 的锅</h2><p>不要误会，DropShadowEffect并没有什么过错。只是在特定情境下，DropShadowEffect（及其他所有Effect类），就是WPF渲染瓶颈的关键： </p>
<ul>
<li>将Effect应用到时刻变化的元素</li>
<li>在应用了Effect的元素上，叠加了其他时刻变化的兄弟元素</li>
<li>… </li>
</ul>
<p>远程会议的问题就是碰到了第二种情景，我们以为只要不直接应用DropShadowEffect到D3DImage这种时刻更新帧的元素上，应该就能避免渲染瓶颈，然而被打脸。<br>说了这么久，好像还是没有说为什么；年轻人，不要这么着急，继续往下看。  </p>
<h2 id="WPF-的渲染知识两则"><a href="#WPF-的渲染知识两则" class="headerlink" title="WPF 的渲染知识两则"></a>WPF 的渲染知识两则</h2><ul>
<li>当WPF在渲染一个窗口的时候，它只更新需要更新的区域，称为脏区（DirtyRect）。</li>
<li>显存的占用与渲染面积成正相关</li>
</ul>
<p>使用下面这个例子来模拟导致问题的场景：<br><br>左边是应用了DropShadowEffect的Grid,中间是应用ColorAnimation的Grid,右边是3个视频渲染。暂时来说，情况看起来还是可以的，没有出现明显的渲染卡顿，整个界面的渲染都维持在一个比较高的帧数。<br><img src="/2017/09/20/WPF_rendering_perf/origin_gif.gif" alt="origin_gif.gif" title=""><br>那么，将中间的元素叠加在左边的元素上看看：<br><img src="/2017/09/20/WPF_rendering_perf/overlay_lag.gif" alt="overlay_lag.gif" title=""><br>问题出现了，帧率下降严重,视频出现卡顿，ColorAnimation变得不平滑：<br><img src="/2017/09/20/WPF_rendering_perf/overlay_gif.gif" alt="overlay_gif.gif" title=""><br>在这两种情况下，脏区数量都是一样的，分别是始终变化的ColorAnimation Grid和视频区，唯一不同的是，ColorAnimation Grid的位置变了，与应用了DropShadowEffect的Grid部分重叠了，这导致每帧渲染多了一个HW IRT(hardware intermediate render target)，对于WPF来说，HW IRT是一个代价高昂的渲染过程，比它更惨的是SW IRT,如果你的WPF程序在渲染过程中出现多个这种渲染过程，那么可以肯定你的程序需要完成大量的工作来渲染你的程序。</p>
<h2 id="那么，什么是IRT"><a href="#那么，什么是IRT" class="headerlink" title="那么，什么是IRT?"></a>那么，什么是IRT?</h2><p>Intermediate Render Target。在现代的图形处理单元(GPU)中，我们可以将我们要进行渲染的内容先在Render Target中渲染，然后像素着色器可以通过处理这个Render Target来添加特定的效果，这个过程完成后才将处理完的数据储存到后台缓存（Back Buffer)，这个时候渲染线程（Render Thread)可以将back buffer拷贝到前台缓存（Front Buffer)进行显示。对应到上面的例子，动态元素在拥有DropShadowEffect的元素上刷新，引起脏区更新，这个脏区有关DropShadwoEffect，DropShadowEffect需要像素着色器渲染指令（因为它本身就是由HLSL创建的），嘣！！！，IRT就来了。但是，IRT在一次渲染中是很正常的啊，有些WPF程序在一次渲染中可能存在几个IRT都不会引起这么明显的性能下降。4K是性能的试金石，要知道，我们的程序是运行在4K下的，变化的脏区面积足够大，才引起了显著的性能下降，而且，不要忘了，WPF在使用像素着色器时有天生的缺陷，这篇<a href="https://jeremiahmorrill.wordpress.com/2011/02/14/a-critical-deep-dive-into-the-wpf-rendering-system/" target="_blank" rel="external">文章</a>有详细说明,其中提到的关键一点： </p>
<blockquote>
<p>WPF has an extensible pixel shader API, along with some build in effects.  This allows developers to really add some very unique effects to their UI.  In Direct3D when you apply a shader to an existing texture, it’s very typical to use an intermediate rendertarget…after all you can’t sample from a texture you are writing to!  WPF does this also, but unfortunately it will create a totally new texture EACH FRAME and destroy it when it’s done.  Creating and destroying GPU resources is one of the slowest things you can do on a per frame basis.  I wouldn’t even typically do this with system memory allocations of that size. There would be a considerable performance increase on the use of shaders if somehow these intermediate surfaces can be reused.  If you’ve ever wondered why you get noticeable CPU usage with these hardware accelerated shaders, this is why.  </p>
</blockquote>
<p>至此，WPF的渲染相关文章结束。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">


    <div class="bdsharebuttonbox">
    <a href="#" class="bds_more" data-cmd="more">分享到：</a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a>    
    <a href="#" class="bds_sqq" data-cmd="qzone" title="分享给QQ好友">QQ</a>
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a>
</div>
<script>
window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"share":{"bdSize":16}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>
<style>
    .bdshare_popup_box {
        border-radius: 4px;
        border: #e1e1e1 solid 1px;
    }
    .bdshare-button-style0-16 a,
    .bdshare-button-style0-16 .bds_more {
        padding-left: 20px;
        margin: 6px 10px 6px 0;
    }
    .bdshare_dialog_list a,
    .bdshare_popup_list a,
    .bdshare_popup_bottom a {
        font-family: 'Microsoft Yahei';
    }
    .bdshare_popup_top {
        display: none;
    }
    .bdshare_popup_bottom {
        height: auto;
        padding: 5px;
    }
</style>


</div>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-D3DImageInDepth" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/09/11/D3DImageInDepth/">D3DImage - 它能做啥、解决了什么问题、有哪些瓶颈、怎么最佳实践</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/09/11/D3DImageInDepth/">
            <time datetime="2017-09-11T04:19:30.000Z" itemprop="datePublished">2017-09-11</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/技术/">技术</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/D3DImage/">D3DImage</a>, <a class="tag-link" href="/tags/DirectX/">DirectX</a>, <a class="tag-link" href="/tags/WPF/">WPF</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            <p><p>D3dImage，.Net Framework 3.5 之后，微软提供的一个全新的ImageSource<a href="https://msdn.microsoft.com/en-us/library/system.windows.interop.d3dimage.aspx">对象</a>，可以在WPF中很好的呈现DirectX内容；在此之前，你只能将DirectX内容直接渲染在Windows窗口之上，这必然引起令人头疼的AirSpace问题，为了在这些内容上面添加我们习以为常的WPF UI 元素，你只能使用Popup来承载这些内容，完全丧失WPF UI开发的灵活性，且有经验的WPF程序员都知道一个事实：WPF Popup就是一个深坑 - 你需要手动处理各种显示隐藏问题、因为其导致的焦点问题，显示层级问题以及最令人头疼的性能问题，特别是在4K屏幕下，因为我们都知道，Popup就是一个Window，为了解决Airspace问题而使用Popup来承载UI必定需要使其AllowTransparency=True，这就引起了另外一个问题，透明窗口占用内存与其面积成正相关，在4K屏幕下，你可能将整个程序大部分的内存占用贡献给了这些Popup UI。说了这么多，好像在诉控Popup有多么的垃圾（它的确如此，如果在做大量的UI容器时）。 </p>
<p>年轻人，如果你觉得Airspace问题真的没有办法解决了，只能用Popup这种技术手段来规避了，那么听老人一句话，不要浪费时间在Popup上了，因为你在前期投入的时间来规避种种Popup UI导致的问题以及各种你意想不到的Bug，到最后总会碰到解决不了，完全不能规避的情况，从而导致整个Popup UI替换方案完全失败的情形。<br></p>
            <p class="article-more-link">
                <a href="/2017/09/11/D3DImageInDepth/#more">查看更多</a>
            </p>
        
        </div>
        <footer class="article-footer">
            <div class="share-container">


    <div class="bdsharebuttonbox">
    <a href="#" class="bds_more" data-cmd="more">分享到：</a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a>    
    <a href="#" class="bds_sqq" data-cmd="qzone" title="分享给QQ好友">QQ</a>
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a>
</div>
<script>
window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"share":{"bdSize":16}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>
<style>
    .bdshare_popup_box {
        border-radius: 4px;
        border: #e1e1e1 solid 1px;
    }
    .bdshare-button-style0-16 a,
    .bdshare-button-style0-16 .bds_more {
        padding-left: 20px;
        margin: 6px 10px 6px 0;
    }
    .bdshare_dialog_list a,
    .bdshare_popup_list a,
    .bdshare_popup_bottom a {
        font-family: 'Microsoft Yahei';
    }
    .bdshare_popup_top {
        display: none;
    }
    .bdshare_popup_bottom {
        height: auto;
        padding: 5px;
    }
</style>


</div>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-FFmpegCookbook_1" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/08/18/FFmpegCookbook_1/">FFmpeg 入门</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/08/18/FFmpegCookbook_1/">
            <time datetime="2017-08-18T04:19:30.000Z" itemprop="datePublished">2017-08-18</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/技术/">技术</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/FFmpeg/">FFmpeg</a>, <a class="tag-link" href="/tags/解码/">解码</a>, <a class="tag-link" href="/tags/音视频/">音视频</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>废话少说，要解码一个视频帧，你需要这样做：</p>
<div id="flowchart-0" class="flow-chart"></div>

<p>获得帧数据后，用SDL还是直接用D3d渲染，那就看你自己了。<script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script><textarea id="flowchart-0-code" style="display: none">st=>start: Start
e=>end: End
o=>operation: 初始化
av_register_all;
avformat_network_init;
o1=>operation: 打开文件:
avformat_open_input;
o2=>operation: 获取stream并打开符合的codec :
avformat_find_stream_info;
avcodec_find_decoder;
avcodec_open2;
o3=>operation: av_read_frame;
avcodec_decode_video2;
st->o->o1->o2->o3->e</textarea><textarea id="flowchart-0-options" style="display: none">{"scale":1,"line-width":2,"line-length":50,"text-margin":10,"font-size":12,"line-height":30}</textarea><script>  var code = document.getElementById("flowchart-0-code").value;  var options = JSON.parse(decodeURIComponent(document.getElementById("flowchart-0-options").value));  var diagram = flowchart.parse(code);  diagram.drawSVG("flowchart-0", options);</script></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">


    <div class="bdsharebuttonbox">
    <a href="#" class="bds_more" data-cmd="more">分享到：</a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a>    
    <a href="#" class="bds_sqq" data-cmd="qzone" title="分享给QQ好友">QQ</a>
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a>
</div>
<script>
window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"share":{"bdSize":16}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>
<style>
    .bdshare_popup_box {
        border-radius: 4px;
        border: #e1e1e1 solid 1px;
    }
    .bdshare-button-style0-16 a,
    .bdshare-button-style0-16 .bds_more {
        padding-left: 20px;
        margin: 6px 10px 6px 0;
    }
    .bdshare_dialog_list a,
    .bdshare_popup_list a,
    .bdshare_popup_bottom a {
        font-family: 'Microsoft Yahei';
    }
    .bdshare_popup_top {
        display: none;
    }
    .bdshare_popup_bottom {
        height: auto;
        padding: 5px;
    }
</style>


</div>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-D3DImageInWPF" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/06/11/D3DImageInWPF/">D3DImage in WPF</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/06/11/D3DImageInWPF/">
            <time datetime="2017-06-11T15:10:50.000Z" itemprop="datePublished">2017-06-11</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/技术/">技术</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/D3DImage/">D3DImage</a>, <a class="tag-link" href="/tags/DirectX/">DirectX</a>, <a class="tag-link" href="/tags/WPF/">WPF</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>在.Net Framework 3.5 SP1中，微软在WPF中提供了D3DImage对象，D3DImage是一个ImageSource，这可以让我们在WPF原生的D3D Surface上渲染Direct3D Surface，大大提高了WPF和DirectX内容的交互性。<br>在此之前，要想在WPF上渲染DirectX的内容，只能让DirectX直接渲染到窗口上，这样会造成不可避免的Airspace问题，因为DirectX内容要时刻刷新重绘，导致WPF窗口上的其他内容被覆盖，表现就是DirectX内容始终在窗口最顶层。<br>正如前面所说，D3DImage是一个ImageSource，在WPF中，这意味着，我们可以将一个3D场景变成一个Image对象的Source，或者构建一个ImageBrush，这意味这D3D Surface可以渲染到WPF中任意一个以Brush进行渲染的元素上，例如图片，文本前景色，元素背景色等等。<br>如下，就是一个典型的应用D3DImage的代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (d3dimg.IsFrontBufferAvailable)</div><div class="line">&#123;</div><div class="line">    IntPtr pSurface = IntPtr.Zero;</div><div class="line">    pSurface = _view.GetBackBuffer();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (pSurface != IntPtr.Zero)</div><div class="line">    &#123;</div><div class="line">        d3dimg.Lock();</div><div class="line">        d3dimg.SetBackBuffer(D3DResourceType.IDirect3DSurface9,pSurface);</div><div class="line">        _view.Draw();</div><div class="line">        d3dimg.AddDirtyRect(<span class="keyword">new</span> Int32Rect(<span class="number">0</span>, <span class="number">0</span>, d3dimg.PixelWidth, d3dimg.PixelHeight));</div><div class="line">        d3dimg.Unlock();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>只需要Direct3D内容渲染的Surface接口指针即可，如上面的pSurface。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">


    <div class="bdsharebuttonbox">
    <a href="#" class="bds_more" data-cmd="more">分享到：</a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a>    
    <a href="#" class="bds_sqq" data-cmd="qzone" title="分享给QQ好友">QQ</a>
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a>
</div>
<script>
window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"share":{"bdSize":16}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>
<style>
    .bdshare_popup_box {
        border-radius: 4px;
        border: #e1e1e1 solid 1px;
    }
    .bdshare-button-style0-16 a,
    .bdshare-button-style0-16 .bds_more {
        padding-left: 20px;
        margin: 6px 10px 6px 0;
    }
    .bdshare_dialog_list a,
    .bdshare_popup_list a,
    .bdshare_popup_bottom a {
        font-family: 'Microsoft Yahei';
    }
    .bdshare_popup_top {
        display: none;
    }
    .bdshare_popup_bottom {
        height: auto;
        padding: 5px;
    }
</style>


</div>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-ThereIsNoThread" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/05/02/ThereIsNoThread/">【翻译】There Is No Thread</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/05/02/ThereIsNoThread/">
            <time datetime="2017-05-02T10:14:58.000Z" itemprop="datePublished">2017-05-02</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/翻译/">翻译</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/async-await/">async/await</a>, <a class="tag-link" href="/tags/翻译/">翻译</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h2 id="这里并没有线程"><a href="#这里并没有线程" class="headerlink" title="这里并没有线程"></a>这里并没有线程</h2><p>原文地址： <a href="http://blog.stephencleary.com/2013/11/there-is-no-thread.html" target="_blank" rel="external">http://blog.stephencleary.com/2013/11/there-is-no-thread.html</a></p>
<hr>
<p>最纯粹的async形式中存在一个重要的真相：这里并没有线程（或者不存在新建的线程）<br>举不胜数的反对者哭喊道：“不！如果我正在等待一个操作，那一定存在一个线程在等待这个操作！它可能是一个线程池中的线程。或者是系统线程！或者是其他类似设备驱动的东西…”。</p>
<p>不要听从那些哭喊的人。如果那些async操作是纯粹的，那么这里将不会存在线程。</p>
<p>那些持怀疑态度的人并没有被说服。让我们来娱乐一下他们。</p>
<p>我们可以一路跟踪一条异步操作指令到硬件层面，特别留意其中的.Net部分和设备驱动部分。为了简化这部分描述，我们排除掉部分中间层的细节，但是这应该不会让我们偏离真相。</p>
<p>思考一个通用的“写”操作（写一个文件、网络流、USB等等）。我们的代码很简单：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">private <span class="keyword">async</span> <span class="keyword">void</span> Button_Clicked(object sender, RoutedEventArgs e)</div><div class="line">&#123;</div><div class="line">    byte[] data = ...</div><div class="line">    await myDevice.WriteAsync(data, <span class="number">0</span>, data.Length);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们早就知道，UI线程并不会被await操作阻塞。那么问题来了：这里是不是存在另外一个线程，它牺牲自己所以UI线程才能存活？  </p>
<p>抓住我的手，我们要潜的更深一点。</p>
<p>第一站：类库（例如，查看BCL代码）。我们假设 WriteAsync 是用 .Net 标准的 P/Invoke 异步 I/O 操作实现的。所以，这个操作在设备的句柄上开始了一个Win32的重叠I/O操作。</p>
<p>系统紧接着转到设备驱动并让设备开始写操作。它首先构造一个表示写请求的对象，这被称为I/O Request Packet(IRP)。设备驱动获得这个IRP并向设备发起命令来写对应的数据。如果设备支持Direct Memory Access(DMA)，这个操作就像向设备寄存器中写入缓存地址一样简单。这是设备驱动能做的所有事情；它使得IRP进入“等待”并转回到系统。</p>
<p><img src="http://blog.stephencleary.com/assets/Os1.png" alt=""></p>
<p>事实的核心：当处理IRP时，设备驱动不允许堵塞。这意味着，如果IRP不能立即完成，那么它一定要异步执行。这对于同步API也一样成立。在设备驱动这一层，所有（重要的）请求都是异步的。<br>随着IRP进入“等待”状态，系统通过返回一个未完成的Task给刚才堵塞的async按钮点击事件，然后UI线程继续执行。<br>我们深入追踪到系统底层的写操作，直至物理设备。<br>现在，写操作正在执行，那有多少线程在处理它呢？  </p>
<h3 id="一个都没有"><a href="#一个都没有" class="headerlink" title="一个都没有"></a>一个都没有</h3><p>这里并没有设备驱动线程，系统线程，BLC线程或者线程池线程在处理那个写操作。<strong>这里根本就没有线程</strong><br>现在，我们看一下对应的回复（Response)。<br>写请求开始片刻，设备完成了写操作，他通过中断（Interrupt)通知CPU。<br>设备驱动的Interrupt Service Routine(ISR)对这个中断做出反应。中断是CPU层的时间，它会临时从当前CPU所运行的线程中获得CPU的控制权。你可以认为ISR是在“借用”当前正在运行的线程，但是我更倾向于认为ISR在更底层中执行，底层到根本不存在线程这个概念的水平。或者说它在所有线程之下。<br>无论如何，ISR已经被妥当的进行了写操作，它做的所有事情就是告诉设备“谢谢你的中断请求”并且将一个Deferred Procedure Call(DPC)入队（queue)。<br>当CPU被中断“骚扰”完之后，它会转向它的DPC。DPC也是在一个不能直接用线程描述的底层水平。和ISR一样，DPC直接在CPU上执行，在线程系统之下。<br>DPC获取代表写操作的ISR并将其标志成“完成”。然而，那么“完成”状态只存在系统层；必须要通知到进程自己拥有的内存空间。所以系统会入队一个special-kernel-mode Asynchronous Procedure Call(APC)给拥有HANDLE的线程。<br>因为上述提到的类库/BLC使用的是标准P/Inovke Overlapped I/O 系统，它早就注册了I/O Completion Port(IOCP)的句柄，这个句柄是线程池的一部分。所以，一个I/O线程池线程被短暂的“借用”来执行APC,通过它来通知task已经完成。<br>现在task捕获了UI线程的上下文，它不直接从线程池线程中返回async方法，相反，它将async方法后续的执行加入到UI线程的上下文，当UI线程执行到这里的时候就会继续执行这部分代码。<br>所以，当请求发生时，我们可以看到这里并没有线程。当请求完成时，大量的线程被“借用”或者短暂暂存到它们那里。这些工作大约在一毫秒（运行在线程池的APC)或者低到一微秒（例如ISR)。但是这里并没有线程因为等待请求完毕而被堵塞。</p>
<p><img src="http://blog.stephencleary.com/assets/Os2.png" alt=""></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">


    <div class="bdsharebuttonbox">
    <a href="#" class="bds_more" data-cmd="more">分享到：</a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a>    
    <a href="#" class="bds_sqq" data-cmd="qzone" title="分享给QQ好友">QQ</a>
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a>
</div>
<script>
window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"share":{"bdSize":16}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>
<style>
    .bdshare_popup_box {
        border-radius: 4px;
        border: #e1e1e1 solid 1px;
    }
    .bdshare-button-style0-16 a,
    .bdshare-button-style0-16 .bds_more {
        padding-left: 20px;
        margin: 6px 10px 6px 0;
    }
    .bdshare_dialog_list a,
    .bdshare_popup_list a,
    .bdshare_popup_bottom a {
        font-family: 'Microsoft Yahei';
    }
    .bdshare_popup_top {
        display: none;
    }
    .bdshare_popup_bottom {
        height: auto;
        padding: 5px;
    }
</style>


</div>

            
    

        </footer>
    </div>
    
</article>



    <nav id="page-nav">
        <a class="extend prev" rel="prev" href="/">&laquo; 上一页</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/">下一页 &raquo;</a>
    </nav>
</section>
            
                <aside id="sidebar">
   
        
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2019/01/15/loop-hoisting/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <!-- <p class="item-category"></p> -->
                            <p class="item-title"><a href="/2019/01/15/loop-hoisting/" class="title">Loop Hoisting</a></p>
                            <p class="item-date"><time datetime="2019-01-14T17:52:23.000Z" itemprop="datePublished">2019-01-15</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/12/26/csharp-memory-model-part-1/" class="thumbnail">
    
    
        <span style="background-image:url(https://avatars2.githubusercontent.com/u/9141961?s=200&amp;v=4)" alt="C# 内存模型" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <!-- <p class="item-category"><a class="article-category-link" href="/categories/技术/">技术</a></p> -->
                            <p class="item-title"><a href="/2018/12/26/csharp-memory-model-part-1/" class="title">C# 内存模型</a></p>
                            <p class="item-date"><time datetime="2018-12-26T07:43:56.000Z" itemprop="datePublished">2018-12-26</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/08/23/tail-recursion/" class="thumbnail">
    
    
        <span style="background-image:url(https://avatars2.githubusercontent.com/u/9141961?s=200&amp;v=4)" alt="C# 尾递归优化" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <!-- <p class="item-category"><a class="article-category-link" href="/categories/技术/">技术</a></p> -->
                            <p class="item-title"><a href="/2018/08/23/tail-recursion/" class="title">C# 尾递归优化</a></p>
                            <p class="item-date"><time datetime="2018-08-22T16:41:31.000Z" itemprop="datePublished">2018-08-23</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/07/16/filtering-in-business-logic/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <!-- <p class="item-category"></p> -->
                            <p class="item-title"><a href="/2018/07/16/filtering-in-business-logic/" class="title">业务逻辑中的 Filter</a></p>
                            <p class="item-date"><time datetime="2018-07-16T03:50:00.000Z" itemprop="datePublished">2018-07-16</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/06/01/debugging-mlt/" class="thumbnail">
    
    
        <span style="background-image:url(https://www.mltframework.org/assets/img/mlt-logo-128.png)" alt="使用 IDE 编译调试 Mlt framework" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <!-- <p class="item-category"></p> -->
                            <p class="item-title"><a href="/2018/06/01/debugging-mlt/" class="title">使用 IDE 编译调试 Mlt framework</a></p>
                            <p class="item-date"><time datetime="2018-06-01T05:32:41.000Z" itemprop="datePublished">2018-06-01</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">分类</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/图片/">图片</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/">技术</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/摄影/">摄影</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/翻译/">翻译</a><span class="category-list-count">3</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">归档</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">3</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">标签</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/BUG/">BUG</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C#</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CLOO/">CLOO</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/D3DImage/">D3DImage</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DirectX/">DirectX</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Extension/">Extension</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FFmpeg/">FFmpeg</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GPU/">GPU</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Guangzhou/">Guangzhou</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LayeredWindow/">LayeredWindow</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Loop-Hoisting/">Loop Hoisting</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mlt-Framework/">Mlt Framework</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NET-Standard/">NET Standard</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nikon/">Nikon</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenCL/">OpenCL</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Perforator/">Perforator</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Performance/">Performance</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Profiling/">Profiling</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Timelapse/">Timelapse</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VSCode/">VSCode</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Video/">Video</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Visual-Studio/">Visual Studio</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Volatile/">Volatile</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WPF/">WPF</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Xcode/">Xcode</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/async-await/">async/await</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/design-pattern/">design pattern</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/filter/">filter</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/内存模型/">内存模型</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/单反/">单反</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/图像处理/">图像处理</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/尾递归/">尾递归</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/曼德博集合/">曼德博集合</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/渲染/">渲染</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/编译器优化/">编译器优化</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/翻译/">翻译</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/解码/">解码</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/通用计算/">通用计算</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/音视频/">音视频</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/高性能计算/">高性能计算</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/高斯模糊/">高斯模糊</a><span class="tag-list-count">1</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/BUG/" style="font-size: 10px;">BUG</a> <a href="/tags/C/" style="font-size: 15px;">C#</a> <a href="/tags/CLOO/" style="font-size: 12.5px;">CLOO</a> <a href="/tags/D3DImage/" style="font-size: 12.5px;">D3DImage</a> <a href="/tags/DirectX/" style="font-size: 17.5px;">DirectX</a> <a href="/tags/Extension/" style="font-size: 12.5px;">Extension</a> <a href="/tags/FFmpeg/" style="font-size: 10px;">FFmpeg</a> <a href="/tags/GPU/" style="font-size: 10px;">GPU</a> <a href="/tags/Guangzhou/" style="font-size: 10px;">Guangzhou</a> <a href="/tags/LayeredWindow/" style="font-size: 12.5px;">LayeredWindow</a> <a href="/tags/Loop-Hoisting/" style="font-size: 10px;">Loop Hoisting</a> <a href="/tags/Mlt-Framework/" style="font-size: 12.5px;">Mlt Framework</a> <a href="/tags/NET-Standard/" style="font-size: 10px;">NET Standard</a> <a href="/tags/Nikon/" style="font-size: 10px;">Nikon</a> <a href="/tags/OpenCL/" style="font-size: 17.5px;">OpenCL</a> <a href="/tags/Perforator/" style="font-size: 10px;">Perforator</a> <a href="/tags/Performance/" style="font-size: 12.5px;">Performance</a> <a href="/tags/Profiling/" style="font-size: 10px;">Profiling</a> <a href="/tags/Timelapse/" style="font-size: 10px;">Timelapse</a> <a href="/tags/VSCode/" style="font-size: 10px;">VSCode</a> <a href="/tags/Video/" style="font-size: 10px;">Video</a> <a href="/tags/Visual-Studio/" style="font-size: 15px;">Visual Studio</a> <a href="/tags/Volatile/" style="font-size: 10px;">Volatile</a> <a href="/tags/WPF/" style="font-size: 20px;">WPF</a> <a href="/tags/Xcode/" style="font-size: 10px;">Xcode</a> <a href="/tags/async-await/" style="font-size: 10px;">async/await</a> <a href="/tags/design-pattern/" style="font-size: 10px;">design pattern</a> <a href="/tags/filter/" style="font-size: 10px;">filter</a> <a href="/tags/内存模型/" style="font-size: 10px;">内存模型</a> <a href="/tags/单反/" style="font-size: 10px;">单反</a> <a href="/tags/图像处理/" style="font-size: 12.5px;">图像处理</a> <a href="/tags/尾递归/" style="font-size: 10px;">尾递归</a> <a href="/tags/曼德博集合/" style="font-size: 10px;">曼德博集合</a> <a href="/tags/渲染/" style="font-size: 12.5px;">渲染</a> <a href="/tags/编译器优化/" style="font-size: 10px;">编译器优化</a> <a href="/tags/翻译/" style="font-size: 15px;">翻译</a> <a href="/tags/解码/" style="font-size: 10px;">解码</a> <a href="/tags/通用计算/" style="font-size: 10px;">通用计算</a> <a href="/tags/音视频/" style="font-size: 10px;">音视频</a> <a href="/tags/高性能计算/" style="font-size: 15px;">高性能计算</a> <a href="/tags/高斯模糊/" style="font-size: 10px;">高斯模糊</a>
        </div>
    </div>

    
        
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
                    <li>
                        <a href="http://lindexi.oschina.io/">林德熙的博客</a>
                    </li>
                
                    <li>
                        <a href="https://walterlv.github.io/blog/">吕毅的博客</a>
                    </li>
                
            </ul>
        </div>
    </div>


    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>
            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2019 gandalfliang<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
        </div>
    </div>
</footer>
        

    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>