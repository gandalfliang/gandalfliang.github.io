<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="generator" content="Hexo 4.2.0"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>gandalfliang的个人博客</title><meta property="og:type" content="blog"><meta property="og:title" content="gandalfliang的个人博客"><meta property="og:url" content="https://gandalfliang.github.io/"><meta property="og:site_name" content="gandalfliang的个人博客"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://gandalfliang.github.io/img/og_image.png"><meta property="article:author" content="gandalfliang"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://gandalfliang.github.io"},"headline":"gandalfliang的个人博客","image":["https://gandalfliang.github.io/img/og_image.png"],"author":{"@type":"Person","name":"gandalfliang"},"description":null}</script><link rel="icon" href="/img/gandalf_me.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><script data-ad-client="ca-pub-1228574210145482" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/gandalf_me.png" alt="gandalfliang的个人博客" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item is-active" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2019-01-23T10:56:15.000Z" title="2019-01-23T10:56:15.000Z">2019-01-23</time><span class="level-item">几秒 读完 (大约 4 个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/01/23/tags-for-the-past-two-years/">Tags for the past Two years</a></h1><div class="content"><img src="/2019/01/23/tags-for-the-past-two-years/tags.png" alt="tags.png" title=""></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2019-01-22T11:18:13.000Z" title="2019-01-22T11:18:13.000Z">2019-01-22</time><span class="level-item"><a class="link-muted" href="/categories/%E8%B0%83%E8%AF%95/">调试</a></span><span class="level-item">4 分钟 读完 (大约 525 个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/01/22/c-cli-debug-assembly-load-error/">定位 C++/CLI 库的加载失败异常</a></h1><div class="content"><p>程序在加载 C++/CLI 动态库的时候，出现 <code>FileLoadException</code>，常见错误是其中某些依赖没有找到，这个时候异常信息应该是类似：一个xxx的依赖没有找到；这个问题很好解决，确定缺少的依赖补充上就可以了，可以使用 <code>dumpbin</code> 工具查看相关的依赖：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dumpbin /dependents target.dll</div></pre></td></tr></table></figure></p>
<p>但是，有一种比较隐晦的错误导致动态库加载失败，错误提示：<code>未能加载由xxx.dll导入的过程</code>，除了这些，几乎没有什么有用的错误信息让我们来确定到底出现了什么问题。一般来说，按照目前我遇到的问题，这个一般都是对应的库文件调用了当前平台不支持的api导致的。当然，这个问题不易在开发的机器上发现，因为能调用到这个api就代表调试机器上有对应平台版本的SDK，一般如果前期没有发现到这个问题，那么问题被发现时肯定是在生成环境，所以需要开发人员注意调用接口的支持平台。  </p>
<p>要定位是什么接口导致的问题，需要借助其他的调试工具来排查。微软的 Windows SDK 提供了对应的工具 <code>gflags.exe</code>，借助这个工具，我们可以在调试的过程中看到详细的动态库加载信息，在这些信息中可以定位到底是什么接口导致库文件加载失败。当然，你需要在出现问题的机器上使用这个工具进行操作，并通过 Visual Studio 进行远程调试。  </p>
<img src="/2019/01/22/c-cli-debug-assembly-load-error/gflags.png" alt="gflags.png" title="">  
<p>如上图显示，通过输入你程序的名字和开启 <code>Show loader snaps</code> 开关，应用后使用 Visual Studio 进行调试，可以在输出窗口看到详细的加载信息： </p>
<img src="/2019/01/22/c-cli-debug-assembly-load-error/locate_error.png" alt="locate_error.png" title="">  </div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2019/01/17/jit-loop-invariant-hoisting/"><img class="thumbnail" src="https://avatars2.githubusercontent.com/u/9141961?s=200&amp;v=4" alt="JIT Loop Invariant Hoisting"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2019-01-17T11:06:38.000Z" title="2019-01-17T11:06:38.000Z">2019-01-17</time><span class="level-item"><a class="link-muted" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a></span><span class="level-item">7 分钟 读完 (大约 1058 个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/01/17/jit-loop-invariant-hoisting/">JIT Loop Invariant Hoisting</a></h1><div class="content"><p>在上一篇<a href="./2019/01/15/loop-hoisting/">文章</a>中，我们已经对 <code>Loop Invariant</code> 概念有一个简单的了解，在文章的最后提到的 <code>Loop Invariant</code> 将在这篇文章做一个简单的介绍。</p>
<h2 id="在我们开始之前"><a href="#在我们开始之前" class="headerlink" title="在我们开始之前"></a>在我们开始之前</h2><p>如果你了解 <code>C#</code> 程序的运行，应该知道 <code>C#</code> 代码先被编译器编译为 <code>MSIL</code> 中间代码，在实际运行的时候才通过 <code>JIT</code> 编译器将 <code>MSIL</code> 代码编译成机器代码并运行。因此，编译器有两个时段可以对代码进行优化：</p>
<ul>
<li><strong>C#</strong> -&gt; <strong>MSIL</strong></li>
<li><strong>MSIL</strong> -&gt; <strong>MACHINE CODE</strong>  </li>
</ul>
<p>但是，C#到MSIL的优化有限，大部分优化都是通过 <code>JIT</code> 来完成的。而这篇文章也是围绕微软最新的 <code>RyuJIT</code> 编译器来展开，其可能与旧的 <code>JIT</code>有所区别，但是应该差异不大。</p>
<h2 id="Loop-Invariant"><a href="#Loop-Invariant" class="headerlink" title="Loop Invariant"></a>Loop Invariant</h2><p>首先看一下微软对 <a href="https://github.com/dotnet/coreclr/blob/master/Documentation/botr/ryujit-overview.md#loop-invariant-code-hoisting" target="_blank" rel="external"><code>Loop Invariant Code Hoisting</code></a> 的说明：</p>
<blockquote>
<p>This phase traverses all the loop nests, in outer-to-inner order (thus hoisting expressions outside the largest loop in which they are invariant). It traverses all of the statements in the blocks in the loop that are always executed. If the statement is:  </p>
<ul>
<li>A valid CSE candidate</li>
<li>Has no side-effects</li>
<li>Does not raise an exception OR occurs in the loop prior to any side-effects</li>
<li>Has a valid value number, and it is a lclVar defined outside the loop, or its children (the value numbers from which it was computed) are invariant.</li>
</ul>
</blockquote>
<p><code>JIT</code> 从外到内遍历所有的循环嵌套。它遍历循环嵌套结构中始终会被运行的<code>BasicBlock</code>（这是<code>JIT</code>里的类型，这里暂不展开，你可以暂时将其理解为编译器的基本类型）里的语句，并且这些语句符合以下条件：  </p>
<ul>
<li>是一个 <code>CSE</code></li>
<li>没有副作用</li>
<li>不会触发异常或者发生在任何副作用之前</li>
<li>拥有一个可用的数字，这个数字定义在循环嵌套外或者其子元素是不可变的</li>
</ul>
<hr>
<p>上面提到的始终会被运行的循环嵌套（loop that are always executed), 如何理解? 嗯…，简单来讲，我们知道的循环结构，例如大部分编程语言都会有的 for loop 和 do while loop，这两种循环嵌套中，do while loop 就符合一定会被执行的循环嵌套，因为循环判断在一次循环后才会执行，而有些for loop 也可以被转换为 do while loop, <code>JIT</code> 会判断这个loop能否转换为do while loop后才进行后续的 loop hoisting 操作。</p>
<h2 id="CSE-Common-Subexpression-Elimination"><a href="#CSE-Common-Subexpression-Elimination" class="headerlink" title="CSE - Common Subexpression Elimination"></a>CSE - Common Subexpression Elimination</h2><blockquote>
<p>Utilizes value numbers to identify redundant computations, which are then evaluated to a new temp lvlVar, and then reused.</p>
</blockquote>
<p>利用数字来识别（替代？）多余的计算，然后将它们计算为新的临时值，并重复利用。就如上篇文章中for循环中的 <code>x+y</code>。<br>观察<code>RyuJIT</code> 中用于判定<code>CSE</code>的函数片段：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*****************************************************************************</span></div><div class="line"> *</div><div class="line"> *  The following determines whether the given expression is a worthy CSE</div><div class="line"> *  candidate.</div><div class="line"> */</div><div class="line"><span class="keyword">bool</span> Compiler::optIsCSEcandidate(GenTreePtr tree)</div><div class="line">&#123;</div><div class="line">     <span class="comment">/* No good if the expression contains side effects or if it was marked as DONT CSE */</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span>  (tree-&gt;gtFlags &amp; (GTF_ASG|GTF_DONT_CSE))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span>  <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/* The only reason a TYP_STRUCT tree might occur is as an argument to</span></div><div class="line">       GT_ADDR. It will never be actually materialized. So ignore them.</div><div class="line">       Also TYP_VOIDs */</div><div class="line"></div><div class="line">    var_types   type = tree-&gt;TypeGet();</div><div class="line">    genTreeOps  oper = tree-&gt;OperGet();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (type == TYP_STRUCT || type == TYP_VOID)</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _TARGET_X86_</span></div><div class="line">    <span class="keyword">if</span> (type == TYP_FLOAT)</div><div class="line">    &#123;</div><div class="line">        <span class="comment">// TODO-X86-CQ: Revisit this</span></div><div class="line">        <span class="comment">// Don't CSE a TYP_FLOAT on x86 as we currently can only enregister doubles </span></div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">    <span class="keyword">if</span> (oper == GT_CNS_DBL)</div><div class="line">    &#123;</div><div class="line">        <span class="comment">// TODO-CQ: Revisit this</span></div><div class="line">        <span class="comment">// Don't try to CSE a GT_CNS_DBL as they can represent both float and doubles</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">    ...</div><div class="line">  <span class="comment">/* Check for some special cases */</span></div><div class="line"></div><div class="line">    <span class="keyword">switch</span> (oper)</div><div class="line">    &#123;</div><div class="line">        ...</div><div class="line"></div><div class="line">        <span class="keyword">case</span> GT_LCL_VAR:</div><div class="line">        <span class="keyword">return</span>  <span class="literal">false</span>;   <span class="comment">// Can't CSE a volatile LCL_VAR</span></div><div class="line"></div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>当然，这个函数还有许多细节，这里只挑选几个典型的片段。看代码可以知道：  </p>
<ul>
<li><strong>可以明确指定不能使用 CSE</strong></li>
<li><strong>不能有赋值表达式</strong></li>
<li><strong>在x86下 float 不能作为 CSE, x64 下不支持 float 和 double</strong></li>
<li><strong>不支持 struct 和 void</strong> </li>
<li><strong>如果是可变 (volatile) 的变量，也不能作为CSE，这在之前的一篇<a href="https://gandalfliang.github.io/2018/12/26/csharp-memory-model-part-1/">文章</a>中有对 volatile 的说明</strong></li>
</ul>
<p><code>Loop-Hoisting</code> 还有颇多细节这里并没有覆盖，有兴趣可以去看源码：<a href="https://github.com/dotnet/coreclr/blob/master/src/jit/optimizer.cpp" target="_blank" rel="external">https://github.com/dotnet/coreclr/blob/master/src/jit/optimizer.cpp</a></p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2019/01/15/loop-hoisting/"><img class="thumbnail" src="https://avatars2.githubusercontent.com/u/9141961?s=200&amp;v=4" alt="Loop Hoisting"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2019-01-14T17:52:23.000Z" title="2019-01-14T17:52:23.000Z">2019-01-15</time><span class="level-item"><a class="link-muted" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a></span><span class="level-item">6 分钟 读完 (大约 844 个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/01/15/loop-hoisting/">Loop Hoisting</a></h1><div class="content"><p>在<a href="https://gandalfliang.github.io/2018/12/26/csharp-memory-model-part-1/">上篇文章</a>中，提到 <code>Loop Hoisting</code> ，这是一个常见的编译器优化项。我们总是能通过汇编代码等低级语言来“窥探”代码实际是怎么“指示”硬件运行的（这边文章不会涉及到详细的汇编内容，但是会用C#反编译后得到的汇编代码来辅助说明）。如果你看过我前面的几篇文章，会发现我用了大量反编译后的汇编代码来辅助说明，毕竟，千言不如实际的“证据”有说服力。</p>
<hr>
<p>言归正传，<code>Loop Hoisting</code>，循环提升（粗略的翻译），编译器对循环代码中 <code>loop-invariant</code> 的代码提取出循环体外，防止循环结构内CPU对主存的重复读取。这很好理解，减少 CPU 与主存之间的 <code>IO</code> 次数，能有效提升程序的运行效率。观察下面的例子：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">namespace loop_hoisting</div><div class="line">&#123;</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Program</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">void</span> Main(string[] args)</div><div class="line">        &#123;</div><div class="line">            int[] array = <span class="keyword">new</span> int[] &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> &#125;;</div><div class="line">            int x = <span class="number">10</span>;</div><div class="line">            int y = <span class="number">11</span>;</div><div class="line"></div><div class="line">            LoopHoistTest(array, x, y);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">static</span> <span class="keyword">void</span> LoopHoistTest(int[] array, int x, int y)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; array.Length; i++)</div><div class="line">            &#123;</div><div class="line">                array[i] = x + y;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>很简单的一个例子，遍历列表且赋值。<code>LoopHoistTest</code> 函数的循环判断里，直接读取列表的长度，编译器在碰到这种情况，会对其进行优化，将对列表长度的读取进行提升（Hoist)，在循环体入口处缓存列表长度，并以此为判断依据，也就是说，从汇编代码的角度，循环判断始终去寄存器中读取缓存的列表长度信息，而不是每次都到主存中读取，以此来提到运行效率。另外，<code>x+y</code>很明显也是一段 <code>loop-invariant</code> 代码，相似地，编译器会将 <code>x+y</code> 的值缓存在某个通用寄存器内，并以此做赋值运算。编译器优化后的代码，就相当于：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">namespace loop_hoisting</div><div class="line">&#123;</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Program</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">void</span> Main(string[] args)</div><div class="line">        &#123;</div><div class="line">            int[] array = <span class="keyword">new</span> int[] &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> &#125;;</div><div class="line">            int x = <span class="number">10</span>;</div><div class="line">            int y = <span class="number">11</span>;</div><div class="line"></div><div class="line">            LoopHoistTest(array, x, y);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">static</span> <span class="keyword">void</span> LoopHoistTest(int[] array, int x, int y)</div><div class="line">        &#123;</div><div class="line">            int length = array.Length;</div><div class="line">            int sum = x+y;</div><div class="line"></div><div class="line">            <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; length; i++)</div><div class="line">            &#123;</div><div class="line">                array[i] = sum;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>观察汇编代码：<br><img src="/2019/01/15/loop-hoisting/optLoopHoisting_opted.png" alt="optLoopHoisting_opted.png" title=""><br>第一个红色框选的汇编代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mov   ebx,dword ptr [rsi+<span class="number">8</span>] <span class="comment">//将rsi寄存器值加上8的偏移量指向的主存中的值复制到ebx通用寄存器</span></div></pre></td></tr></table></figure></p>
<p>其中 <code>rsi</code> 寄存器中的值就是主存中 <code>array</code> 的地址，偏移的8位指向 <code>length</code>  字段，这段指令将数值中的长度信息储存在 <code>ebx</code> 通用寄存器中，并且在以后的 <code>cmp</code> 指令中使用，而不是直接与主存中的内容比较。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">lea   ebp,[rdx+r8] <span class="comment">//将 rdx 和 r8 寄存器中的值相加并传送到 ebp 寄存器</span></div></pre></td></tr></table></figure></p>
<p>其中，<code>rdx</code> 和 <code>r8</code> 寄存器分别储存着 x 和 y 的值，两者的和被储存在 <code>ebp</code> 寄存器，以后的指令都使用这个寄存器中的值，不再重复计算。  </p>
<p>当然，并不是所有的循环代码都可以被优化，这涉及到 <code>Loop-invariant</code> 条件的判定，我们下篇文章再讲。</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2018/12/26/csharp-memory-model-part-1/"><img class="thumbnail" src="https://avatars2.githubusercontent.com/u/9141961?s=200&amp;v=4" alt="C# 内存模型"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-12-26T07:43:56.000Z" title="2018-12-26T07:43:56.000Z">2018-12-26</time><span class="level-item"><a class="link-muted" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a></span><span class="level-item">10 分钟 读完 (大约 1445 个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/12/26/csharp-memory-model-part-1/">C# 内存模型</a></h1><div class="content"><p>在 C# 的语言规范中 <a href="http://www.ecma-international.org/publications/files/ECMA-ST/ECMA-334.pdf">ECMA-334</a>，对于<code>Volatile</code>关键字的描述：</p>
<blockquote>
<p><em>15.5.4 Volatile fields<br>When a field-declaration includes a volatile modifier, the fields introduced by that declaration are volatile fields. For non-volatile fields, optimization techniques that reorder instructions can lead to unexpected and unpredictable results in multi-threaded programs that access fields without synchronization such as that provided by the lock-statement (§13.13). These optimizations can be<br>performed by the compiler, by the run-time system, or by hardware. For volatile fields, such reordering optimizations are restricted:</em></p>
<ul>
<li><em>A read of a volatile field is called a volatile read. A volatile read has “acquire semantics”; that is, it is guaranteed to occur prior to any references to memory that occur after it in the instruction sequence.</em>  </li>
<li><em>A write of a volatile field is called a volatile write. A volatile write has “release semantics”; that is, it is guaranteed to happen after any memory references prior to the write instruction in the instruction sequence.</em></li>
</ul>
</blockquote>
<p>简单来说，对于常规字段，由于代码优化而导致指令顺序改变，如果没有进行一定的同步控制，在多线程应用中可能会导致意想不到的结果，而造成这种意外的原因可能是编译器优化、运行时系统的优化或者因为硬件的原因（即CPU和主存储器的通信模型）。可变(volatile)字段会限制这种优化的发生，在这里引入两个定义：</p>
<ul>
<li><p>可变读： 对于可变字段的读操作会<code>获取语义</code>。即，其可以保证对于可变字段的内存读取操作一定发生在其后内存操作指令的前面。进一步解释，与 <strong>Thread.MemoryBarrier</strong> 类似，获取语义会保证在读取可变字段指令前的指令可以跨越它出现在它后面，但是相反地，在它后面的指令不能跨越它出现在它的前面。例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Volatile_class</span></div><div class="line"></span>&#123;</div><div class="line">    private int _a;</div><div class="line">    private volatile int _b;</div><div class="line">    private int _c;</div><div class="line"></div><div class="line">    private <span class="keyword">void</span> Call()</div><div class="line">    &#123;</div><div class="line">        int temp=_a;</div><div class="line">        <span class="comment">//由于_b是可变字段，这样可以保证编译器不会将temp2=_c的指令提前到其之前</span></div><div class="line">        <span class="comment">//但是，可以将temp=_a提到其之后</span></div><div class="line">        int temp1=_b;</div><div class="line">        int temp2=_c;</div><div class="line"></div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private <span class="keyword">void</span> OtherCall()&#123;...&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>可变写： 对于可变字段的写操作会<code>释放语义</code>。即，其可以保证对于可变字段的写操作发生在其前面指令执行之后，但是在它之后的指令可以跨域它提前执行。</p>
</li>
</ul>
<h2 id="X86-X64"><a href="#X86-X64" class="headerlink" title="X86_X64"></a>X86_X64</h2><p>现代的 x86_x64 CPU 可以保证字段的读写都是 “volatile” 的，即你不会读取到旧的字段值，这是由  CPU 提供保证的。这样看起来好像与上面的描述存在矛盾，如果 CPU 可以保证所有字段的读写都是 <em>volatile</em> ,那为什么还需要在语言层面提供<code>volatile</code>关键字。其实这是两个不同的概念，CPU 从硬件层面上保证了对内存的读写是实时的，你不会读取到 Stale Value ,无论这个字段是常规字段还是可变字段。而语言层面上的 <code>volatile</code> 只是一个关键字，告诉编译器不能对该字段进行 <strong>instruction reorder</strong> 等可能导致多线程读写出现不符合预期结果的优化(暂且这样理解)。</p>
<p>参考这段代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Program</span></div><div class="line"></span>&#123;</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">infinity_loop</span></div><div class="line">    </span>&#123;</div><div class="line">        public bool Terminated;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="keyword">void</span> Main(string[] args)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">var</span> loop=<span class="keyword">new</span> infinity_loop();</div><div class="line"></div><div class="line">        <span class="keyword">new</span> Thread(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</div><div class="line">            loop.Terminated=<span class="literal">true</span>;</div><div class="line">        &#125;).Start();</div><div class="line"></div><div class="line">        <span class="keyword">while</span>(!loop.Terminated);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>使用 dotnet core Release 模式运行这段代码，可以发现它永远也不会退出，分析汇编代码：<br></div><a class="article-more button is-small size-small" href="/2018/12/26/csharp-memory-model-part-1/#more">阅读更多</a></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2018/08/23/tail-recursion/"><img class="thumbnail" src="https://avatars2.githubusercontent.com/u/9141961?s=200&amp;v=4" alt="C# 尾递归优化"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-08-22T16:41:31.000Z" title="2018-08-22T16:41:31.000Z">2018-08-23</time><span class="level-item"><a class="link-muted" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a></span><span class="level-item">5 分钟 读完 (大约 709 个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/08/23/tail-recursion/">C# 尾递归优化</a></h1><div class="content"><h2 id="何为尾递归"><a href="#何为尾递归" class="headerlink" title="何为尾递归"></a><strong>何为尾递归</strong></h2><p>有时候我们使用递归来解决一些特定的问题，但是使用递归需要注意不要导致栈溢出，这是使用递归的一个常见问题，对于规模足够大的问题，使用递归必定会导致栈溢出。通常，我们可以通过尾递归进行优化，尾递归可以避免栈溢出的问题（暂且这样认为）。<br>尾递归并不是什么新奇的东西，理解起来很简单，对于递归，如果上层调用的返回结果不依赖子调用的结果，那么，这就是一个尾递归。例如：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">///这是一个简单的尾递归例子</span></div><div class="line">namespace tail</div><div class="line">&#123;</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Program</span></div><div class="line">    </span>&#123;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">void</span> Main(string[] args)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">var</span> test=RetrieveData(<span class="number">100000000000000</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">static</span> long RetrieveData(long unit)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (unit == <span class="number">0</span>)</div><div class="line">                <span class="keyword">return</span> unit;</div><div class="line">            <span class="keyword">return</span> RetrieveData(--unit);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="等等，好像有什么地方不对"><a href="#等等，好像有什么地方不对" class="headerlink" title="等等，好像有什么地方不对"></a><strong>等等，好像有什么地方不对</strong></h2><p>从上面的例子分析，代码依旧会导致栈溢出，不是吗？是的，聪明的你答对了。那为什么说尾递归可以避免栈溢出问题？当然，从刚才的结论看，这个问题提的并不准确，尾递归并不能避免栈溢出问题。<br>仔细想想，尾递归结构和循环结构是类似的，上面的尾递归可以写成：<br></div><a class="article-more button is-small size-small" href="/2018/08/23/tail-recursion/#more">阅读更多</a></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-07-16T03:50:00.000Z" title="2018-07-16T03:50:00.000Z">2018-07-16</time><span class="level-item">5 分钟 读完 (大约 729 个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/07/16/filtering-in-business-logic/">业务逻辑中的 Filter</a></h1><div class="content"><h2 id="Pipe-and-Filter"><a href="#Pipe-and-Filter" class="headerlink" title="Pipe and Filter"></a>Pipe and Filter</h2><p>在一些应用的开发场景中，例如，大量的数据处理、需要对数据进行大量的转换和过滤，使用管道和<code>Filter</code>是一个很好的选择。对于这种应用场景，一般都需要处理业务足够灵活，并且足够健壮。想象一下，为了实现相应的过滤功能，使用大量的<code>if</code>或者<code>switch case</code>,日后维护这套代码的人估计也会抓狂的吧，单元测试编写起来，应该也够呛吧。</p>
<h2 id="用Filter来处理业务"><a href="#用Filter来处理业务" class="headerlink" title="用Filter来处理业务"></a>用<code>Filter</code>来处理业务</h2><p>Filter一般都被认为是用来处理数据的，其实，更近一步，用来”处理”业务，也不失为一种好办法。当然，这里的处理，并不是说在Filter中执行业务，考虑到业务都是一些耗时（但不绝对）的操作，在管道中处理业务是不对的，这样会堵塞整条管道。相反地，我们的业务依赖管道中的数据，我们希望在数据处理的过程中，由数据的处理来触发特定的业务，因此，我们定义一种BusinessFilter，其不对数据进行处理，而是作为一种窥探，“假装”自己是在进行数据处理，实际是根据数据的实际来通知外界做相应的业务而已。<br><img src="/2018/07/16/filtering-in-business-logic/pipe.png" alt="pipe.png" title="">  </p>
<h2 id="灵活性"><a href="#灵活性" class="headerlink" title="灵活性"></a>灵活性</h2><p>正如上图的结构，搭积木式的链式结构可以根据业务的调整进行对应的调整，不同的业务可以在通道中穿插。从另一个方面可以看出，我们设计Filter的时候，保持它的独立性是至关重要的，一个Filter完成一个工作，而且不受其他Filter影响是保持整个链式结构灵活的关键。</p>
<h2 id="健壮性"><a href="#健壮性" class="headerlink" title="健壮性"></a>健壮性</h2><p>一般来说，管道/Filter结构一旦确定，会做大调整的几率都不高。由于Filter的存在，所有的变动在改动之前就可以确定影响范围，而且可以限制调整带来的结构变动。</p>
<h2 id="存在的问题"><a href="#存在的问题" class="headerlink" title="存在的问题"></a>存在的问题</h2><ul>
<li>几乎所有的Pipe/Filter结构都是线性结构，这种情况限制了async/await的应用</li>
<li>如果一个Filter只接受一种数据类型，那么存在的数据转换会降低我们系统的性能，特别地，如果是C#，进行引用类型和值类型的转换，频繁的装箱拆箱也会降低我们系统的性能；为了解决这种问题，限制Filter可接受的数据类型，这样就不能随意连接Filter到所有数据类型，通用性降低。</li>
<li>…</li>
</ul>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2018/06/01/debugging-mlt/"><img class="thumbnail" src="https://www.mltframework.org/assets/img/mlt-logo-128.png" alt="使用 IDE 编译调试 Mlt framework"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-06-01T05:32:41.000Z" title="2018-06-01T05:32:41.000Z">2018-06-01</time><span class="level-item">3 分钟 读完 (大约 446 个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/06/01/debugging-mlt/">使用 IDE 编译调试 Mlt framework</a></h1><div class="content"><p><a href="https://www.mltframework.org/" target="_blank" rel="external"><code>Mlt framework</code></a> 是一个开源跨平台的多媒体处理框架，使用模块化的设计，集成了大量的业界领先的视频处理框架，如ffmpeg，良好的设计，可以方便的集成自己的模块进去，利用它，你可以实现自己的 Adobe Premiere 等非线性多媒体编辑软件或者视频播放器，简单几句代码为视频添加炫酷的转场效果和滤镜。 </p>
<p>由于跨平台，项目通过configure的方式来管理工程，对于学习来说多媒体框架来说，调试起来并不方便，我整理了CMake的脚本，可以通过cmake来生成我们熟悉的 Visual Studio 或者 Xcode<br>工程，方便调试。  </p>
<p>在阅读下面文章之前，请确保你有一定的 MinGW 工具链使用经验。 </p>
<h3 id="下载源码"><a href="#下载源码" class="headerlink" title="下载源码"></a>下载源码</h3><p><a href="https://github.com/gandalfliang/mlt" target="_blank" rel="external">https://github.com/gandalfliang/mlt</a><br>分支：cmake</p>
<h3 id="配置环境"><a href="#配置环境" class="headerlink" title="配置环境"></a>配置环境</h3><p>对于 Windows 平台：  </p>
<ol>
<li>cmake</li>
<li>MinGW </li>
<li>msys2</li>
<li>Windows SDK  </li>
</ol>
<p>确保MinGW和msys2里的工具链路径在系统变量PATH中</p>
<p>Mac 平台：</p>
<ol>
<li>Xcode  </li>
</ol>
<h3 id="Bootstrap"><a href="#Bootstrap" class="headerlink" title="Bootstrap"></a>Bootstrap</h3><p>在工程跟目录，运行脚本（如果是 Windows 平台，从开发者命令行工具运行）：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">py bootstrap.py</div></pre></td></tr></table></figure></p>
<p>如果一切顺利，工程文件将会在 <code>build/win32</code> 或者 <code>build/mac</code> 下。脚本运行要拉取ffmpeg的源码并configure，这是一个耗时的工作。在Windows平台下configure ffmpeg将是一个漫长的等待，没事的话，去喝杯咖啡，或者有空的时候在命令窗里敲一下enter键，可能会有收获哦。</p>
<p>完成后，你就可以愉快的调试这个框架了。 </p>
<img src="/2018/06/01/debugging-mlt/mac.png" alt="mac.png" title=""></div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2018/04/17/debug_mlt_vscode/"><img class="thumbnail" src="https://www.mltframework.org/assets/img/mlt-logo-128.png" alt="Debug Mlt Framework in VSCode"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-04-16T17:21:38.000Z" title="2018-04-16T17:21:38.000Z">2018-04-17</time><span class="level-item"><a class="link-muted" href="/categories/%E5%9B%BE%E7%89%87/">图片</a></span><span class="level-item">几秒 读完 (大约 27 个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/04/17/debug_mlt_vscode/">Debug Mlt Framework in VSCode</a></h1><div class="content"><h2 id="Debugging-Mlt-framework-in-VSCode"><a href="#Debugging-Mlt-framework-in-VSCode" class="headerlink" title="Debugging Mlt framework in VSCode"></a><code>Debugging Mlt framework in VSCode</code></h2><img src="/2018/04/17/debug_mlt_vscode/mlt_vscode.png" alt="mlt_vscode.png" title="">
<p>Crossing platform with built in tool chain</p>
<img src="/2018/04/17/debug_mlt_vscode/mlt_vscode_osx.png" alt="mlt_vscode_osx.png" title="">  
<p>Coming up soon (maybe)</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2018/03/21/Gitsoler1_1/"><img class="thumbnail" src="https://gandalfliang.gallerycdn.vsassets.io/extensions/gandalfliang/gitsoler/1.0/1513392739696/Microsoft.VisualStudio.Services.Icons.Default" alt="Gitsoler"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-03-21T03:01:38.000Z" title="2018-03-21T03:01:38.000Z">2018-03-21</time><span class="level-item"><a class="link-muted" href="/categories/%E5%B7%A5%E5%85%B7/">工具</a></span><span class="level-item">几秒 读完 (大约 12 个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/03/21/Gitsoler1_1/">Gitsoler</a></h1><div class="content"><h1 id="Gitsoler-1-1-Split-View-supported-https-marketplace-visualstudio-com-items-itemName-gandalfliang-gitsoler"><a href="#Gitsoler-1-1-Split-View-supported-https-marketplace-visualstudio-com-items-itemName-gandalfliang-gitsoler" class="headerlink" title="Gitsoler 1.1 - Split View supported: https://marketplace.visualstudio.com/items?itemName=gandalfliang.gitsoler"></a>Gitsoler 1.1 - Split View supported: <a href="https://marketplace.visualstudio.com/items?itemName=gandalfliang.gitsoler" target="_blank" rel="external">https://marketplace.visualstudio.com/items?itemName=gandalfliang.gitsoler</a></h1></div></article></div><nav class="pagination is-centered mt-4" role="navigation" aria-label="pagination"><div class="pagination-previous is-invisible is-hidden-mobile"><a href="/page/0/">上一页</a></div><div class="pagination-next"><a href="/page/2/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link is-current" href="/">1</a></li><li><a class="pagination-link" href="/page/2/">2</a></li><li><a class="pagination-link" href="/page/3/">3</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://avatars3.githubusercontent.com/u/5707551?v=3&amp;s=460" alt="gandalfliang"></figure><p class="title is-size-4 is-block line-height-inherit">gandalfliang</p><p class="is-size-6 is-block">gandalfliang@outlook.com</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Guangzhou, CN</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">26</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">6</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">45</p></a></div></div></nav><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="http://github.com/gandalfliang"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content size-small"><p><time dateTime="2019-01-23T10:56:15.000Z">2019-01-23</time></p><p class="title is-6"><a class="link-muted" href="/2019/01/23/tags-for-the-past-two-years/">Tags for the past Two years</a></p><p class="is-uppercase"></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2019-01-22T11:18:13.000Z">2019-01-22</time></p><p class="title is-6"><a class="link-muted" href="/2019/01/22/c-cli-debug-assembly-load-error/">定位 C++/CLI 库的加载失败异常</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/%E8%B0%83%E8%AF%95/">调试</a></p></div></article><article class="media"><a class="media-left" href="/2019/01/17/jit-loop-invariant-hoisting/"><p class="image is-64x64"><img class="thumbnail" src="https://avatars2.githubusercontent.com/u/9141961?s=200&amp;v=4" alt="JIT Loop Invariant Hoisting"></p></a><div class="media-content size-small"><p><time dateTime="2019-01-17T11:06:38.000Z">2019-01-17</time></p><p class="title is-6"><a class="link-muted" href="/2019/01/17/jit-loop-invariant-hoisting/">JIT Loop Invariant Hoisting</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a></p></div></article><article class="media"><a class="media-left" href="/2019/01/15/loop-hoisting/"><p class="image is-64x64"><img class="thumbnail" src="https://avatars2.githubusercontent.com/u/9141961?s=200&amp;v=4" alt="Loop Hoisting"></p></a><div class="media-content size-small"><p><time dateTime="2019-01-14T17:52:23.000Z">2019-01-15</time></p><p class="title is-6"><a class="link-muted" href="/2019/01/15/loop-hoisting/">Loop Hoisting</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a></p></div></article><article class="media"><a class="media-left" href="/2018/12/26/csharp-memory-model-part-1/"><p class="image is-64x64"><img class="thumbnail" src="https://avatars2.githubusercontent.com/u/9141961?s=200&amp;v=4" alt="C# 内存模型"></p></a><div class="media-content size-small"><p><time dateTime="2018-12-26T07:43:56.000Z">2018-12-26</time></p><p class="title is-6"><a class="link-muted" href="/2018/12/26/csharp-memory-model-part-1/">C# 内存模型</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">广告</h3><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-1228574210145482" data-ad-slot="0" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/%E5%9B%BE%E7%89%87/"><span class="level-start"><span class="level-item">图片</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E5%B7%A5%E5%85%B7/"><span class="level-start"><span class="level-item">工具</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E6%8A%80%E6%9C%AF/"><span class="level-start"><span class="level-item">技术</span></span><span class="level-end"><span class="level-item tag">15</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E6%91%84%E5%BD%B1/"><span class="level-start"><span class="level-item">摄影</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E7%BF%BB%E8%AF%91/"><span class="level-start"><span class="level-item">翻译</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E8%B0%83%E8%AF%95/"><span class="level-start"><span class="level-item">调试</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2019/01/"><span class="level-start"><span class="level-item">一月 2019</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2018/12/"><span class="level-start"><span class="level-item">十二月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2018/08/"><span class="level-start"><span class="level-item">八月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2018/07/"><span class="level-start"><span class="level-item">七月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2018/06/"><span class="level-start"><span class="level-item">六月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2018/04/"><span class="level-start"><span class="level-item">四月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2018/03/"><span class="level-start"><span class="level-item">三月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2018/02/"><span class="level-start"><span class="level-item">二月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2018/01/"><span class="level-start"><span class="level-item">一月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2017/12/"><span class="level-start"><span class="level-item">十二月 2017</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2017/10/"><span class="level-start"><span class="level-item">十月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2017/09/"><span class="level-start"><span class="level-item">九月 2017</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2017/08/"><span class="level-start"><span class="level-item">八月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2017/06/"><span class="level-start"><span class="level-item">六月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2017/05/"><span class="level-start"><span class="level-item">五月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2017/03/"><span class="level-start"><span class="level-item">三月 2017</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/BUG/"><span class="tag">BUG</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/C/"><span class="tag">C#</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/C-CLI/"><span class="tag">C++/CLI</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CLOO/"><span class="tag">CLOO</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/D3DImage/"><span class="tag">D3DImage</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DirectX/"><span class="tag">DirectX</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Extension/"><span class="tag">Extension</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/FFmpeg/"><span class="tag">FFmpeg</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GPU/"><span class="tag">GPU</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Guangzhou/"><span class="tag">Guangzhou</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/LayeredWindow/"><span class="tag">LayeredWindow</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Loop-Hoisting/"><span class="tag">Loop Hoisting</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Loop-Invariant-Hoisting/"><span class="tag">Loop Invariant Hoisting</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Mlt-Framework/"><span class="tag">Mlt Framework</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/NET-Standard/"><span class="tag">NET Standard</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Nikon/"><span class="tag">Nikon</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OpenCL/"><span class="tag">OpenCL</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Perforator/"><span class="tag">Perforator</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Performance/"><span class="tag">Performance</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Profiling/"><span class="tag">Profiling</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RyuJIT/"><span class="tag">RyuJIT</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Timelapse/"><span class="tag">Timelapse</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/VSCode/"><span class="tag">VSCode</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Video/"><span class="tag">Video</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Visual-Studio/"><span class="tag">Visual Studio</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Volatile/"><span class="tag">Volatile</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/WPF/"><span class="tag">WPF</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Xcode/"><span class="tag">Xcode</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/async-await/"><span class="tag">async/await</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/design-pattern/"><span class="tag">design pattern</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/filter/"><span class="tag">filter</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/"><span class="tag">内存模型</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8D%95%E5%8F%8D/"><span class="tag">单反</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/"><span class="tag">图像处理</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B0%BE%E9%80%92%E5%BD%92/"><span class="tag">尾递归</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9B%BC%E5%BE%B7%E5%8D%9A%E9%9B%86%E5%90%88/"><span class="tag">曼德博集合</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%B8%B2%E6%9F%93/"><span class="tag">渲染</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BC%96%E8%AF%91%E5%99%A8%E4%BC%98%E5%8C%96/"><span class="tag">编译器优化</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BF%BB%E8%AF%91/"><span class="tag">翻译</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%A7%A3%E7%A0%81/"><span class="tag">解码</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%B0%83%E8%AF%95/"><span class="tag">调试</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%80%9A%E7%94%A8%E8%AE%A1%E7%AE%97/"><span class="tag">通用计算</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"><span class="tag">音视频</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%AB%98%E6%80%A7%E8%83%BD%E8%AE%A1%E7%AE%97/"><span class="tag">高性能计算</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%AB%98%E6%96%AF%E6%A8%A1%E7%B3%8A/"><span class="tag">高斯模糊</span><span class="tag is-grey-lightest">1</span></a></div></div></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li><li><a class="level is-mobile is-mobile" href="http://lindexi.oschina.io/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">林德熙的博客</span></span><span class="level-right"><span class="level-item tag">lindexi.oschina.io</span></span></a></li><li><a class="level is-mobile is-mobile" href="https://walterlv.github.io/blog/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">吕毅的博客</span></span><span class="level-right"><span class="level-item tag">walterlv.github.io</span></span></a></li></ul></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/gandalf_me.png" alt="gandalfliang的个人博客" height="28"></a><p class="size-small"><span>&copy; 2020 gandalfliang</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'https://gandalfliang.github.io',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>