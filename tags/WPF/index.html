<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="generator" content="Hexo 4.2.0"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>标签: WPF - gandalfliang的个人博客</title><meta property="og:type" content="blog"><meta property="og:title" content="gandalfliang的个人博客"><meta property="og:url" content="https://gandalfliang.github.io/"><meta property="og:site_name" content="gandalfliang的个人博客"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://gandalfliang.github.io/img/og_image.png"><meta property="article:author" content="gandalfliang"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://gandalfliang.github.io"},"headline":"gandalfliang的个人博客","image":["https://gandalfliang.github.io/img/og_image.png"],"author":{"@type":"Person","name":"gandalfliang"},"description":null}</script><link rel="icon" href="/img/gandalf_me.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><script data-ad-client="ca-pub-1228574210145482" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/gandalf_me.png" alt="gandalfliang的个人博客" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">标签</a></li><li class="is-active"><a href="#" aria-current="page">WPF</a></li></ul></nav></div></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2018/02/16/transparent_4k_window.translate/"><img class="thumbnail" src="http://www.iconshock.com/img_vista/FLAT/project_management/jpg/acceleration_graphic2_icon.jpg" alt="【翻译】关于 WPF 透明窗口的内存占用"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-02-16T15:01:38.000Z" title="2018-02-16T15:01:38.000Z">2018-02-16</time><span class="level-item"><a class="link-muted" href="/categories/%E7%BF%BB%E8%AF%91/">翻译</a></span><span class="level-item">7 分钟 读完 (大约 1047 个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/02/16/transparent_4k_window.translate/">【翻译】关于 WPF 透明窗口的内存占用</a></h1><div class="content"><p>翻译自己的文章才是最骚的。。。  <a href="https://gandalfliang.github.io/2018/01/17/transparent_4k_window/">Origin Post</a></p>
<hr>
<p>要实现一个透明的 WPF 窗口？<br>多么简单的一个任务啊！只要设置 AllowTransparency 和 WindowStyle，你可以在毫秒间完成这个任务。  </p>
<p><code>AllowTransparency=&quot;True&quot; WindowStyle=&quot;None&quot; Background=&quot;Transparent&quot;</code>   </p>
<p>正确吧？当然。<br>但是（你懂得），打开你的任务管理器看看，简单的任务通常会带来大量的内存占用，特别是4K分辨率的透明窗口。100+ MB的内存被浪费了，就只为了显示一个空白的透明窗口！这是不可接受的。一年前，如果你说：”谁关心内存呀，现在的内存条太便宜了”，你可能是对的。但是查查这一年内存条的价格走向，它们现在贵上天了。</p>
<h2 id="WPF-透明窗口的有趣小真相"><a href="#WPF-透明窗口的有趣小真相" class="headerlink" title="WPF 透明窗口的有趣小真相"></a>WPF 透明窗口的有趣小真相</h2><ul>
<li><code>内存占用随着窗口尺寸增大而增加</code></li>
<li><code>Win32 窗口没有这样的问题</code>  </li>
</ul>
<p>等等，什么？窗口越大，内存消耗的更多？嗯。。。这看起来很熟悉嘛，就像一个<code>Bitmap</code>。知道现在，我们并不知道 WPF 是如何处理透明窗口的，但是这种症状显示它就好像直接将整个桌面作为一个位图，然后窗口用这张位图的重叠部分作为其背景来更新自己，让它看起来是“透明”的。多么聪明的做法呀。。。<br>在 WPF 刚刚发布的那些日子里，低分辨率的计算机屏幕占据主流位置，即使在今天，大多数的笔记本电脑依然带着一块1366*768分辨率的屏幕被推向市场（离谱吧）。让我们唾弃那些OEM厂商讲的毫无根据的废话并且思考一下运行在高分辨率下的程序的情况。  </p>
<h2 id="内存并不是免费的，不要浪费之"><a href="#内存并不是免费的，不要浪费之" class="headerlink" title="内存并不是免费的，不要浪费之"></a>内存并不是免费的，不要浪费之</h2><p>很显然，浪费100+MB的内存来显示一个4K的透明窗口是不可接受的，特别是和 Win32 窗口只占用10+MB的内存进行比较时。这差距让 WPF 看起来蠢透了。<br>抱怨已经够多了，想想对此我们能做什么呢？我可不想用C++和GDI将我的UI代码重写一遍，这太没效率并且也跟不上时代，况且，没人会为此“区区小事”去放弃他们漂亮、易于维护的Xaml UI代码。  </p>
<h2 id="使用-Win32-承载-WPF-内容"><a href="#使用-Win32-承载-WPF-内容" class="headerlink" title="使用 Win32 承载 WPF 内容"></a>使用 Win32 承载 WPF 内容</h2><p>好吧，确实，没人愿意为了区区90MB内存去重写它们的UI。与使用C++重写UI所耗费的精力相比，这个内存的占用差距看起来是可以接受的（#笑脸）。但是请记住，我们一如既往的可以在 Win32 窗口中承载 WPF 的内容。<br>例如，我们想创建一个全屏、半透明背景带着非透明内容的对话框。为了规避 WPF 透明窗口的内存问题，我们可以使用 Win32 创建一个半透明的窗口：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">DWORD Flags1 = WS_EX_LAYERED;</div><div class="line">DWORD Flags2 = WS_POPUP;</div><div class="line"></div><div class="line">HWND hWnd = CreateWindowEx(Flags1,szWindowClass, szTitle, Flags2,</div><div class="line">    CW_USEDEFAULT, <span class="number">0</span>, <span class="number">3840</span>,<span class="number">2160</span>, nullptr, nullptr, hInstance, nullptr);</div><div class="line"></div><div class="line">SetLayeredWindowAttributes(hWnd, RRR, (BYTE)<span class="number">125</span>, LWA_ALPHA);</div><div class="line">ShowWindow(hWnd, nCmdShow);</div><div class="line">UpdateWindow(hWnd);</div><div class="line"></div><div class="line"><span class="keyword">case</span> WM_ERASEBKGND:</div><div class="line">    RECT rect;</div><div class="line">    GetClientRect(hWnd, &amp;rect);</div><div class="line">    FillRect((HDC)wParam, &amp;rect, CreateSolidBrush(RGB(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)));</div><div class="line">    <span class="keyword">break</span>;</div></pre></td></tr></table></figure></p>
<p>通过启用 <code>C++/CLI</code>，我们可以直接访问 WPF 内容</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">namespace ManagedCode</div><div class="line">&#123;</div><div class="line">    using namespace System;</div><div class="line">    using namespace System::Windows;</div><div class="line">    using namespace System::Windows::Interop;</div><div class="line">    using namespace System::Windows::Media;</div><div class="line"></div><div class="line">    HWND GetHwnd(HWND parent, int x, int y, int width, int height) &#123;</div><div class="line">    HwndSource^ source = gcnew HwndSource(</div><div class="line">        <span class="number">0</span>, <span class="comment">// class style  </span></div><div class="line">        WS_VISIBLE | WS_CHILD, <span class="comment">// style  </span></div><div class="line">        <span class="number">0</span>, <span class="comment">// exstyle  </span></div><div class="line">        x, y, width, height,</div><div class="line">        <span class="string">"hi"</span>, <span class="comment">// NAME  </span></div><div class="line">        IntPtr(parent)        <span class="comment">// parent window   </span></div><div class="line">    );</div><div class="line"></div><div class="line">    UIElement^ page = gcnew ManagedContent::WPFContent();</div><div class="line">    source-&gt;RootVisual = page;</div><div class="line">    <span class="keyword">return</span> (HWND)source-&gt;Handle.ToPointer();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//managed content</span></div><div class="line">ManagedCode::GetHwnd(hWnd, <span class="number">0</span>, <span class="number">0</span>, <span class="number">200</span>, <span class="number">200</span>);</div></pre></td></tr></table></figure>
<p>由于 WPF 和 GDI 背后的技术不尽相同，还有更多的工作需要做来解决不可避免的透明通道问题，但是，为了方便，你始终可以使用 Popup 来实现你的目标。</p>
<hr>
<p>Macbook Pro 2016 的键盘真垃圾。。。。。。</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2018/01/17/transparent_4k_window/"><img class="thumbnail" src="http://www.iconshock.com/img_vista/FLAT/project_management/jpg/acceleration_graphic2_icon.jpg" alt="关于 WPF 透明窗口的内存占用"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-01-17T03:01:38.000Z" title="2018-01-17T03:01:38.000Z">2018-01-17</time><span class="level-item"><a class="link-muted" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a></span><span class="level-item">4 分钟 读完 (大约 573 个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/01/17/transparent_4k_window/">关于 WPF 透明窗口的内存占用</a></h1><div class="content"><p>要实现一个透明的 WPF 窗口？<br>What an easy task! By setting AllowTransparency and WindowStyle, you could finish it in seconds.   </p>
<p><code>AllowTransparency=&quot;True&quot; WindowStyle=&quot;None&quot; Background=&quot;Transparent&quot;</code>   </p>
<p>Correct? Of course.  </p>
<p>However (you know this is coming), look at your task manager, easy task comes with large memory consumption, especially for 4K transparent window. 100+ MB ram are wasted for just showing an empty, transparent window! That’s unacceptable. A year ago, you might be right saying “Who cares about RAM, they are cheap as hell”, but check out the price they’ve grown over this year, they are expensive as hell now.  </p>
<h2 id="Fun-fact-of-WPF-transparent-window"><a href="#Fun-fact-of-WPF-transparent-window" class="headerlink" title="Fun fact of WPF transparent window"></a>Fun fact of WPF transparent window</h2><ul>
<li><code>RAM usage increase as window size enlarge</code>  </li>
<li><code>Win32 window has no such problem</code>  </li>
</ul>
<p>Wait, what? The larger the window is, the more RAM it consumes? Hmmmmm… this looks familiar, just like a <code>Bitmap</code>. For now, we don’t know how WPF handles transparent window, but the symptom shows that it’s like using the whole screen as a bitmap and the window updating itself with portion of that bitmap, making it “transparent”. What a smart move…<br>Back in the days when WPF was first released, low screen resolution was the main stream. Even today, most laptops still are shipping with a monitor of 1366*768 (ridiculous, right?). Let’s despise the nonsense the OEM told us and think about program running in computers with higher screen resolution. </p>
<h2 id="RAM-is-not-free-do-not-waste-it"><a href="#RAM-is-not-free-do-not-waste-it" class="headerlink" title="RAM is not free, do not waste it"></a>RAM is not free, do not waste it</h2><p>Obviously, costing 100+ mb of ram for showing a transparent window in 4K is unacceptable, especially compared with Win32 transparent window, which costs only 10+ mb. The gap between them makes WPF look dump.<br>Enough complaining, what can we do about it? I don’t want to write UI code with GDI using C++, that’s inefficient and not modern, plus, no one would abandon their beautiful, easy to maintain xaml UI code for this.</p>
<h2 id="Hosting-WPF-content-in-Win32-Window"><a href="#Hosting-WPF-content-in-Win32-Window" class="headerlink" title="Hosting WPF content in Win32 Window"></a>Hosting WPF content in Win32 Window</h2><p>Well, indeed, no one would rewrite their UI code for just about 90mb of RAM. Compared with the work needed to rewrite C++ UI code, the RAM consumption gap seems acceptable (#smile face). But please remember, we can always host WPF content in win32 window.<br>Let say, we want to create a full screen notification dialog with semi-transparent background and apaque notication content in the center. To avoid the WPF ram problem, we create a semi-transparent window using win32:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">DWORD Flags1 = WS_EX_LAYERED;</div><div class="line">DWORD Flags2 = WS_POPUP;</div><div class="line"></div><div class="line">HWND hWnd = CreateWindowEx(Flags1,szWindowClass, szTitle, Flags2,</div><div class="line">    CW_USEDEFAULT, <span class="number">0</span>, <span class="number">3840</span>,<span class="number">2160</span>, nullptr, nullptr, hInstance, nullptr);</div><div class="line"></div><div class="line">SetLayeredWindowAttributes(hWnd, RRR, (BYTE)<span class="number">125</span>, LWA_ALPHA);</div><div class="line">ShowWindow(hWnd, nCmdShow);</div><div class="line">UpdateWindow(hWnd);</div><div class="line"></div><div class="line"><span class="keyword">case</span> WM_ERASEBKGND:</div><div class="line">    RECT rect;</div><div class="line">    GetClientRect(hWnd, &amp;rect);</div><div class="line">    FillRect((HDC)wParam, &amp;rect, CreateSolidBrush(RGB(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)));</div><div class="line">    <span class="keyword">break</span>;</div></pre></td></tr></table></figure></p>
<p>By enabling <code>C++/CLI</code>, we can access WPF content directly  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">namespace ManagedCode</div><div class="line">&#123;</div><div class="line">    using namespace System;</div><div class="line">    using namespace System::Windows;</div><div class="line">    using namespace System::Windows::Interop;</div><div class="line">    using namespace System::Windows::Media;</div><div class="line"></div><div class="line">    HWND GetHwnd(HWND parent, int x, int y, int width, int height) &#123;</div><div class="line">    HwndSource^ source = gcnew HwndSource(</div><div class="line">        <span class="number">0</span>, <span class="comment">// class style  </span></div><div class="line">        WS_VISIBLE | WS_CHILD, <span class="comment">// style  </span></div><div class="line">        <span class="number">0</span>, <span class="comment">// exstyle  </span></div><div class="line">        x, y, width, height,</div><div class="line">        <span class="string">"hi"</span>, <span class="comment">// NAME  </span></div><div class="line">        IntPtr(parent)        <span class="comment">// parent window   </span></div><div class="line">    );</div><div class="line"></div><div class="line">    UIElement^ page = gcnew ManagedContent::WPFContent();</div><div class="line">    source-&gt;RootVisual = page;</div><div class="line">    <span class="keyword">return</span> (HWND)source-&gt;Handle.ToPointer();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>and finally  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//managed content</span></div><div class="line">ManagedCode::GetHwnd(hWnd, <span class="number">0</span>, <span class="number">0</span>, <span class="number">200</span>, <span class="number">200</span>);</div></pre></td></tr></table></figure>
<p>Due to the different technologies behind WPF and GDI, more work needed to be done for the unavoidable alpha blending problem, but, you can use wpf popup to achieve your goal for short. </p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/12/02/WPFLostTouchCapability/"><img class="thumbnail" src="http://omg3ewm0l.bkt.clouddn.com/windows-10-bsods-on-asus-pcs-faulty-hardware-corrupted-page-error-492252-2.jpg" alt="“阻断疗法” - 拯救 WPF 启动过程中发生设备热插拔导致触摸失效问题"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-12-02T05:58:27.000Z" title="2017-12-02T05:58:27.000Z">2017-12-02</time><span class="level-item"><a class="link-muted" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a></span><span class="level-item">6 分钟 读完 (大约 892 个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/12/02/WPFLostTouchCapability/">“阻断疗法” - 拯救 WPF 启动过程中发生设备热插拔导致触摸失效问题</a></h1><div class="content"><p>如果你在WPF程序启动过程中进行设备热插拔（例如，插入一个U盘，一个USB摄像头），那么你的WPF程序很有可能失去所有触摸消息响应，通过 Tablet.TabletDevices.Count 检查当前程序的挂靠触摸设备，发现为0。有趣的是，如果你将触摸线重新插拔后，程序恢复正常。所以，这是WPF的Bug，微软的锅。那么这个锅的根本原因是啥？有兴趣的可以调试 .net framework 源码，这里没有深究。<br>如上面讲到，触摸线重新插拔就可以解决这个问题，但是，导致这个问题的热插拔设备也不是触摸设备啊，只是一个普通的U盘，反过来想，如果导致问题的不是触摸设备热插拔，反而触摸设备的热插拔能够修复这个问题，那我能不能“模拟”一下触摸设备的热插拔事件呢？在这篇<a href="https://msdn.microsoft.com/en-us/library/dd901337%28v=vs.90%29.aspx?f=255&amp;MSPPError=-2147217396" target="_blank" rel="external">文章</a>里描述怎样模拟触摸设备移除事件来达到禁用WPF触摸的效果,反过来试试，通过 OnTabletAdded 事件看看能不能发生奇迹。然而，奇迹并没有发生，所以这个方法不行。<br>既然模拟设备添加事件的方法不行，那我从源头阻挡这个问题的发生：启动过程中不要处理设备变动事件。那么问题来了，我想要阻断 win32 WM 事件通知，必须要拿到一个窗口句柄呀，但是在 mainwindow show 出来的时候，这个问题已经发生了，这个时候的阻断已经没有效果了，一定要程序启动一开始做阻断。进一步搜索，这里<a href="https://stackoverflow.com/questions/38642479/how-to-disable-wpf-tablet-support-in-surface-4-pro" target="_blank" rel="external">https://stackoverflow.com/questions/38642479/how-to-disable-wpf-tablet-support-in-surface-4-pro</a> 是一个突破口：  </p>
<blockquote>
<p>WPF does not register to these messages on the applications MainWindow, but through a hidden windows named “SystemResources…” which is created for each application instance. So handling those messages on the MainWindow (which would be easy) does not help here.</p>
</blockquote>
<p>相信看到这里，聪明的你已经知道怎么做了。  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">WPFTouchUtil</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="comment">//添加钩子，阻断设备改动消息</span></div><div class="line">        public <span class="keyword">static</span> <span class="keyword">void</span> HandleDeviceChangedWM()</div><div class="line">        &#123;</div><div class="line">            <span class="comment">// hook into internal class SystemResources to keep it from updating the TabletDevices on system events</span></div><div class="line">            object hwndWrapper = GetSystemResourcesHwnd();</div><div class="line">            <span class="keyword">if</span> (hwndWrapper != <span class="literal">null</span>)</div><div class="line">            &#123;</div><div class="line">                <span class="comment">// invoke hwndWrapper.AddHook( .. our method ..)</span></div><div class="line">                <span class="keyword">var</span> internalHwndWrapperType = hwndWrapper.GetType();</div><div class="line">                <span class="comment">// if the delegate is already set, we have already added the hook.</span></div><div class="line">                <span class="keyword">if</span> (_handleAndHideMessageDelegate == <span class="literal">null</span>)</div><div class="line">                &#123;</div><div class="line">                    <span class="comment">// create the internal delegate that will hook into the window messages</span></div><div class="line">                    <span class="comment">// need to hold a reference to that one, because internally the delegate is stored through a WeakReference object</span></div><div class="line">                    <span class="keyword">var</span> internalHwndWrapperHookDelegate = internalHwndWrapperType.Assembly.GetType(<span class="string">"MS.Win32.HwndWrapperHook"</span>);</div><div class="line">                    <span class="keyword">var</span> handleAndHideMessagesHandle = <span class="keyword">typeof</span>(WPFTouchUtil).GetMethod(nameof(HandleAndHideMessages), BindingFlags.Static | BindingFlags.NonPublic);</div><div class="line">                    _handleAndHideMessageDelegate = Delegate.CreateDelegate(internalHwndWrapperHookDelegate, handleAndHideMessagesHandle);</div><div class="line">                    <span class="comment">// add a delegate that handles WM_TABLET_ADD</span></div><div class="line">                    internalHwndWrapperType.InvokeMember(<span class="string">"AddHook"</span>,</div><div class="line">                        BindingFlags.InvokeMethod | BindingFlags.Instance | BindingFlags.Public,</div><div class="line">                        <span class="literal">null</span>, hwndWrapper, <span class="keyword">new</span> object[] &#123; _handleAndHideMessageDelegate &#125;);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//移除钩子，恢复状态</span></div><div class="line">        public <span class="keyword">static</span> <span class="keyword">void</span> RestoreDeviceChangedWM()</div><div class="line">        &#123;</div><div class="line">            object hwndWrapper = GetSystemResourcesHwnd();</div><div class="line">            <span class="keyword">if</span> (hwndWrapper != <span class="literal">null</span>)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">var</span> internalHwndWrapperType = hwndWrapper.GetType();</div><div class="line"></div><div class="line">                internalHwndWrapperType.InvokeMember(<span class="string">"RemoveHook"</span>,</div><div class="line">                    BindingFlags.InvokeMethod | BindingFlags.Instance | BindingFlags.Public,</div><div class="line">                    <span class="literal">null</span>, hwndWrapper, <span class="keyword">new</span> object[] &#123;_handleAndHideMessageDelegate&#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        private <span class="keyword">static</span> Delegate _handleAndHideMessageDelegate = <span class="literal">null</span>;</div><div class="line"></div><div class="line">        private <span class="keyword">static</span> object GetSystemResourcesHwnd()</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">var</span> internalSystemResourcesType = <span class="keyword">typeof</span>(Application).Assembly.GetType(<span class="string">"System.Windows.SystemResources"</span>);</div><div class="line"></div><div class="line">            <span class="comment">// get HwndWrapper from internal property SystemRessources.Hwnd;</span></div><div class="line">            <span class="keyword">var</span> hwndWrapper = internalSystemResourcesType.InvokeMember(<span class="string">"Hwnd"</span>,</div><div class="line">                        BindingFlags.GetProperty | BindingFlags.Static | BindingFlags.NonPublic,</div><div class="line">                        <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</div><div class="line">            <span class="keyword">return</span> hwndWrapper;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        private <span class="keyword">static</span> IntPtr HandleAndHideMessages(IntPtr hwnd, int msg, IntPtr wParam, IntPtr lParam, ref bool handled)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (msg == (int)WindowMessage.WM_DEVICECHANGE)</div><div class="line">            &#123;</div><div class="line">                handled = <span class="literal">true</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> IntPtr.Zero;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        enum WindowMessage : int</div><div class="line">        &#123;</div><div class="line">            WM_DEVICECHANGE = <span class="number">0x0219</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在程序刚启动的时候添加“阻断”，启动流程过后，不要忘了恢复状态。<br>缺陷，如果程序启动过程中，真的发生了触摸设备变动，也会被阻断。</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/09/20/WPF_rendering_perf/"><img class="thumbnail" src="http://www.iconshock.com/img_vista/FLAT/project_management/jpg/acceleration_graphic2_icon.jpg" alt="WPF 渲染小结"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-09-20T04:19:30.000Z" title="2017-09-20T04:19:30.000Z">2017-09-20</time><span class="level-item"><a class="link-muted" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a></span><span class="level-item">10 分钟 读完 (大约 1514 个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/09/20/WPF_rendering_perf/">WPF 渲染小结</a></h1><div class="content"><p>在上一篇文章<a href="https://gandalfliang.github.io/2017/09/11/D3DImageInDepth/">D3DImage - 它能做啥、解决了什么问题、有哪些瓶颈、怎么最佳实践</a>最后，提到DropShadowEffect严重影响到D3DImage的渲染性能问题，导致程序在渲染8分屏（8个远端视频）的时候，出现严重的性能下降，渲染卡顿。要知道，在使用原生窗口渲染方案渲染8分屏，CPU占用和内存占用也不过25%和~200Mb，稍差一点，使用D3DImage优化后方案渲染，CPU占用并没有出现多大的跳跃，大约在30%左右。即使是添加了DropShadowEffect的情况下，CPU占用和内存占用好像都没有多大变化；既然在CPU和内存占用都没有多大变化的情况下，WPF渲染卡顿，那肯定（可能吧）是“帧生成”时间过长的锅。 </p>
<h2 id="帧生成时间"><a href="#帧生成时间" class="headerlink" title="帧生成时间"></a>帧生成时间</h2><p>玩游戏的人都知道，影响游戏帧数的一个关键因素是帧生成时间，帧生成时间过长必定导致游戏FPS下降，游戏不流畅。帧生成时间并不等同帧更新时间，这个需要搞清楚。例如一个游戏锁帧60FPS,那么帧更新时间为1000/60=16.6ms,通常来说，如果你硬件性能足够强劲，那么帧生成时间要小于16.6ms才能保证游戏运行在60FPS的帧率下，否则会掉帧。类似的，WPF的渲染帧率下降可能（无责任猜想）也是同样的因素导致。But why?  </p>
<h2 id="DropShadowEffect-的锅"><a href="#DropShadowEffect-的锅" class="headerlink" title="DropShadowEffect 的锅"></a>DropShadowEffect 的锅</h2><p>不要误会，DropShadowEffect并没有什么过错。只是在特定情境下，DropShadowEffect（及其他所有Effect类），就是WPF渲染瓶颈的关键： </p>
<ul>
<li>将Effect应用到时刻变化的元素</li>
<li>在应用了Effect的元素上，叠加了其他时刻变化的兄弟元素</li>
<li>… </li>
</ul>
<p>远程会议的问题就是碰到了第二种情景，我们以为只要不直接应用DropShadowEffect到D3DImage这种时刻更新帧的元素上，应该就能避免渲染瓶颈，然而被打脸。<br>说了这么久，好像还是没有说为什么；年轻人，不要这么着急，继续往下看。  </p>
<h2 id="WPF-的渲染知识两则"><a href="#WPF-的渲染知识两则" class="headerlink" title="WPF 的渲染知识两则"></a>WPF 的渲染知识两则</h2><ul>
<li>当WPF在渲染一个窗口的时候，它只更新需要更新的区域，称为脏区（DirtyRect）。</li>
<li>显存的占用与渲染面积成正相关</li>
</ul>
<p>使用下面这个例子来模拟导致问题的场景：<br><br>左边是应用了DropShadowEffect的Grid,中间是应用ColorAnimation的Grid,右边是3个视频渲染。暂时来说，情况看起来还是可以的，没有出现明显的渲染卡顿，整个界面的渲染都维持在一个比较高的帧数。<br><img src="/2017/09/20/WPF_rendering_perf/origin_gif.gif" alt="origin_gif.gif" title=""><br>那么，将中间的元素叠加在左边的元素上看看：<br><img src="/2017/09/20/WPF_rendering_perf/overlay_lag.gif" alt="overlay_lag.gif" title=""><br>问题出现了，帧率下降严重,视频出现卡顿，ColorAnimation变得不平滑：<br><img src="/2017/09/20/WPF_rendering_perf/overlay_gif.gif" alt="overlay_gif.gif" title=""><br>在这两种情况下，脏区数量都是一样的，分别是始终变化的ColorAnimation Grid和视频区，唯一不同的是，ColorAnimation Grid的位置变了，与应用了DropShadowEffect的Grid部分重叠了，这导致每帧渲染多了一个HW IRT(hardware intermediate render target)，对于WPF来说，HW IRT是一个代价高昂的渲染过程，比它更惨的是SW IRT,如果你的WPF程序在渲染过程中出现多个这种渲染过程，那么可以肯定你的程序需要完成大量的工作来渲染你的程序。</p>
<h2 id="那么，什么是IRT"><a href="#那么，什么是IRT" class="headerlink" title="那么，什么是IRT?"></a>那么，什么是IRT?</h2><p>Intermediate Render Target。在现代的图形处理单元(GPU)中，我们可以将我们要进行渲染的内容先在Render Target中渲染，然后像素着色器可以通过处理这个Render Target来添加特定的效果，这个过程完成后才将处理完的数据储存到后台缓存（Back Buffer)，这个时候渲染线程（Render Thread)可以将back buffer拷贝到前台缓存（Front Buffer)进行显示。对应到上面的例子，动态元素在拥有DropShadowEffect的元素上刷新，引起脏区更新，这个脏区有关DropShadwoEffect，DropShadowEffect需要像素着色器渲染指令（因为它本身就是由HLSL创建的），嘣！！！，IRT就来了。但是，IRT在一次渲染中是很正常的啊，有些WPF程序在一次渲染中可能存在几个IRT都不会引起这么明显的性能下降。4K是性能的试金石，要知道，我们的程序是运行在4K下的，变化的脏区面积足够大，才引起了显著的性能下降，而且，不要忘了，WPF在使用像素着色器时有天生的缺陷，这篇<a href="https://jeremiahmorrill.wordpress.com/2011/02/14/a-critical-deep-dive-into-the-wpf-rendering-system/" target="_blank" rel="external">文章</a>有详细说明,其中提到的关键一点： </p>
<blockquote>
<p>WPF has an extensible pixel shader API, along with some build in effects.  This allows developers to really add some very unique effects to their UI.  In Direct3D when you apply a shader to an existing texture, it’s very typical to use an intermediate rendertarget…after all you can’t sample from a texture you are writing to!  WPF does this also, but unfortunately it will create a totally new texture EACH FRAME and destroy it when it’s done.  Creating and destroying GPU resources is one of the slowest things you can do on a per frame basis.  I wouldn’t even typically do this with system memory allocations of that size. There would be a considerable performance increase on the use of shaders if somehow these intermediate surfaces can be reused.  If you’ve ever wondered why you get noticeable CPU usage with these hardware accelerated shaders, this is why.  </p>
</blockquote>
<p>至此，WPF的渲染相关文章结束。</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/09/11/D3DImageInDepth/"><img class="thumbnail" src="http://tse2.mm.bing.net/th?id=OIP.-P-RTcBOr2BUm8a5WoFefAEgEs&amp;pid=15.1" alt="D3DImage - 它能做啥、解决了什么问题、有哪些瓶颈、怎么最佳实践"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-09-11T04:19:30.000Z" title="2017-09-11T04:19:30.000Z">2017-09-11</time><span class="level-item"><a class="link-muted" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a></span><span class="level-item">15 分钟 读完 (大约 2259 个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/09/11/D3DImageInDepth/">D3DImage - 它能做啥、解决了什么问题、有哪些瓶颈、怎么最佳实践</a></h1><div class="content"><p>D3dImage，.Net Framework 3.5 之后，微软提供的一个全新的ImageSource<a href="https://msdn.microsoft.com/en-us/library/system.windows.interop.d3dimage.aspx">对象</a>，可以在WPF中很好的呈现DirectX内容；在此之前，你只能将DirectX内容直接渲染在Windows窗口之上，这必然引起令人头疼的AirSpace问题，为了在这些内容上面添加我们习以为常的WPF UI 元素，你只能使用Popup来承载这些内容，完全丧失WPF UI开发的灵活性，且有经验的WPF程序员都知道一个事实：WPF Popup就是一个深坑 - 你需要手动处理各种显示隐藏问题、因为其导致的焦点问题，显示层级问题以及最令人头疼的性能问题，特别是在4K屏幕下，因为我们都知道，Popup就是一个Window，为了解决Airspace问题而使用Popup来承载UI必定需要使其AllowTransparency=True，这就引起了另外一个问题，透明窗口占用内存与其面积成正相关，在4K屏幕下，你可能将整个程序大部分的内存占用贡献给了这些Popup UI。说了这么多，好像在诉控Popup有多么的垃圾（它的确如此，如果在做大量的UI容器时）。 </p>
<p>年轻人，如果你觉得Airspace问题真的没有办法解决了，只能用Popup这种技术手段来规避了，那么听老人一句话，不要浪费时间在Popup上了，因为你在前期投入的时间来规避种种Popup UI导致的问题以及各种你意想不到的Bug，到最后总会碰到解决不了，完全不能规避的情况，从而导致整个Popup UI替换方案完全失败的情形。<br></div><a class="article-more button is-small size-small" href="/2017/09/11/D3DImageInDepth/#more">阅读更多</a></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/06/11/D3DImageInWPF/"><img class="thumbnail" src="http://tse2.mm.bing.net/th?id=OIP.-P-RTcBOr2BUm8a5WoFefAEgEs&amp;pid=15.1" alt="D3DImage in WPF"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-06-11T15:10:50.000Z" title="2017-06-11T15:10:50.000Z">2017-06-11</time><span class="level-item"><a class="link-muted" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a></span><span class="level-item">2 分钟 读完 (大约 335 个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/06/11/D3DImageInWPF/">D3DImage in WPF</a></h1><div class="content"><p>在.Net Framework 3.5 SP1中，微软在WPF中提供了D3DImage对象，D3DImage是一个ImageSource，这可以让我们在WPF原生的D3D Surface上渲染Direct3D Surface，大大提高了WPF和DirectX内容的交互性。<br>在此之前，要想在WPF上渲染DirectX的内容，只能让DirectX直接渲染到窗口上，这样会造成不可避免的Airspace问题，因为DirectX内容要时刻刷新重绘，导致WPF窗口上的其他内容被覆盖，表现就是DirectX内容始终在窗口最顶层。<br>正如前面所说，D3DImage是一个ImageSource，在WPF中，这意味着，我们可以将一个3D场景变成一个Image对象的Source，或者构建一个ImageBrush，这意味这D3D Surface可以渲染到WPF中任意一个以Brush进行渲染的元素上，例如图片，文本前景色，元素背景色等等。<br>如下，就是一个典型的应用D3DImage的代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (d3dimg.IsFrontBufferAvailable)</div><div class="line">&#123;</div><div class="line">    IntPtr pSurface = IntPtr.Zero;</div><div class="line">    pSurface = _view.GetBackBuffer();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (pSurface != IntPtr.Zero)</div><div class="line">    &#123;</div><div class="line">        d3dimg.Lock();</div><div class="line">        d3dimg.SetBackBuffer(D3DResourceType.IDirect3DSurface9,pSurface);</div><div class="line">        _view.Draw();</div><div class="line">        d3dimg.AddDirtyRect(<span class="keyword">new</span> Int32Rect(<span class="number">0</span>, <span class="number">0</span>, d3dimg.PixelWidth, d3dimg.PixelHeight));</div><div class="line">        d3dimg.Unlock();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>只需要Direct3D内容渲染的Surface接口指针即可，如上面的pSurface。</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/03/03/ACriticalDeepDiveIntoTheWPFRenderingSystem/"><img class="thumbnail" src="https://jeremiahmorrill.files.wordpress.com/2011/02/clip_image004_thumb.png?w=481&amp;h=476" alt="深挖 WPF 渲染系统"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-03-03T07:30:30.000Z" title="2017-03-03T07:30:30.000Z">2017-03-03</time><span class="level-item"><a class="link-muted" href="/categories/%E7%BF%BB%E8%AF%91/">翻译</a></span><span class="level-item">23 分钟 读完 (大约 3384 个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/03/03/ACriticalDeepDiveIntoTheWPFRenderingSystem/">深挖 WPF 渲染系统</a></h1><div class="content"><p>这是一篇2011年的文章，原地址在 <a href="https://jeremiahmorrill.wordpress.com/2011/02/14/a-critical-deep-dive-into-the-wpf-rendering-system/">A Critical Deep Dive into the WPF Rendering System</a>，个人认为到现在都可以给WPF程序开发人员作为一个参考，里面详细讲述了 WPF 这个号称从底层支持硬件加速的 UI 框架为什么有时候看起来并不是那么回事的原因。以下是正文。</p>
<hr>
<p>刚开始我并不认为我会发表这篇文章。在被一些我高度重视的人说服后，我决定要发表这篇文章。那些深入投入微软UX平台的程序员应该更加深入了解这个平台内部是怎么工作的，当他们撞到一睹石墙的时候，他们可以清晰了解到问题所在并且更加准确地沟通他们希望平台做出怎样的改变。</p>
<h2 id="我相信-WPF-和-Silverlight-是精心打造的技术，但是…"><a href="#我相信-WPF-和-Silverlight-是精心打造的技术，但是…" class="headerlink" title="我相信 WPF 和 Silverlight 是精心打造的技术，但是…"></a><strong>我相信 WPF 和 Silverlight 是精心打造的技术，但是…</strong></h2><p>如果这几个月你有关注我的Twitter，你也许会发现我一直在吐槽WPF（Silverlight也一样）的性能。为什么我会这样做？毕竟这些年我花费了大量的时间为这个平台布道、写库、社区帮助和指导等等。准确来讲，我个人全身投入到这个平台里面，我希望这个平台越来越好。</p>
<h2 id="性能，性能，性能"><a href="#性能，性能，性能" class="headerlink" title="性能，性能，性能"></a><strong>性能，性能，性能</strong></h2><p>当在开发沉浸式的、消费者导向的UX的时候，性能是你第一位的特性。性能是你添加其他特性的前提和基础。有多少次因为UI太卡你需要缩小UI的规模？有多少次因为这个技术做不到所以你需要丢弃“开创性的UX模型”？有多少次你告诉客户他们需要一个2.4GHz的四核CPU才能获得全部的体验？我一直以来都被客户问，为什么在PC上拥有4倍于iPad的性能的情况下，WPF程序却做不到像iPad应用那般流畅？<br></div><a class="article-more button is-small size-small" href="/2017/03/03/ACriticalDeepDiveIntoTheWPFRenderingSystem/#more">阅读更多</a></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://avatars3.githubusercontent.com/u/5707551?v=3&amp;s=460" alt="gandalfliang"></figure><p class="title is-size-4 is-block line-height-inherit">gandalfliang</p><p class="is-size-6 is-block">gandalfliang@outlook.com</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Guangzhou, CN</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">26</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">6</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">45</p></a></div></div></nav><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="http://github.com/gandalfliang"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content size-small"><p><time dateTime="2019-01-23T10:56:15.000Z">2019-01-23</time></p><p class="title is-6"><a class="link-muted" href="/2019/01/23/tags-for-the-past-two-years/">Tags for the past Two years</a></p><p class="is-uppercase"></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2019-01-22T11:18:13.000Z">2019-01-22</time></p><p class="title is-6"><a class="link-muted" href="/2019/01/22/c-cli-debug-assembly-load-error/">定位 C++/CLI 库的加载失败异常</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/%E8%B0%83%E8%AF%95/">调试</a></p></div></article><article class="media"><a class="media-left" href="/2019/01/17/jit-loop-invariant-hoisting/"><p class="image is-64x64"><img class="thumbnail" src="https://avatars2.githubusercontent.com/u/9141961?s=200&amp;v=4" alt="JIT Loop Invariant Hoisting"></p></a><div class="media-content size-small"><p><time dateTime="2019-01-17T11:06:38.000Z">2019-01-17</time></p><p class="title is-6"><a class="link-muted" href="/2019/01/17/jit-loop-invariant-hoisting/">JIT Loop Invariant Hoisting</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a></p></div></article><article class="media"><a class="media-left" href="/2019/01/15/loop-hoisting/"><p class="image is-64x64"><img class="thumbnail" src="https://avatars2.githubusercontent.com/u/9141961?s=200&amp;v=4" alt="Loop Hoisting"></p></a><div class="media-content size-small"><p><time dateTime="2019-01-14T17:52:23.000Z">2019-01-15</time></p><p class="title is-6"><a class="link-muted" href="/2019/01/15/loop-hoisting/">Loop Hoisting</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a></p></div></article><article class="media"><a class="media-left" href="/2018/12/26/csharp-memory-model-part-1/"><p class="image is-64x64"><img class="thumbnail" src="https://avatars2.githubusercontent.com/u/9141961?s=200&amp;v=4" alt="C# 内存模型"></p></a><div class="media-content size-small"><p><time dateTime="2018-12-26T07:43:56.000Z">2018-12-26</time></p><p class="title is-6"><a class="link-muted" href="/2018/12/26/csharp-memory-model-part-1/">C# 内存模型</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">广告</h3><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-1228574210145482" data-ad-slot="0" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/%E5%9B%BE%E7%89%87/"><span class="level-start"><span class="level-item">图片</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E5%B7%A5%E5%85%B7/"><span class="level-start"><span class="level-item">工具</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E6%8A%80%E6%9C%AF/"><span class="level-start"><span class="level-item">技术</span></span><span class="level-end"><span class="level-item tag">15</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E6%91%84%E5%BD%B1/"><span class="level-start"><span class="level-item">摄影</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E7%BF%BB%E8%AF%91/"><span class="level-start"><span class="level-item">翻译</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E8%B0%83%E8%AF%95/"><span class="level-start"><span class="level-item">调试</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2019/01/"><span class="level-start"><span class="level-item">一月 2019</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2018/12/"><span class="level-start"><span class="level-item">十二月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2018/08/"><span class="level-start"><span class="level-item">八月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2018/07/"><span class="level-start"><span class="level-item">七月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2018/06/"><span class="level-start"><span class="level-item">六月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2018/04/"><span class="level-start"><span class="level-item">四月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2018/03/"><span class="level-start"><span class="level-item">三月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2018/02/"><span class="level-start"><span class="level-item">二月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2018/01/"><span class="level-start"><span class="level-item">一月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2017/12/"><span class="level-start"><span class="level-item">十二月 2017</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2017/10/"><span class="level-start"><span class="level-item">十月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2017/09/"><span class="level-start"><span class="level-item">九月 2017</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2017/08/"><span class="level-start"><span class="level-item">八月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2017/06/"><span class="level-start"><span class="level-item">六月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2017/05/"><span class="level-start"><span class="level-item">五月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2017/03/"><span class="level-start"><span class="level-item">三月 2017</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/BUG/"><span class="tag">BUG</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/C/"><span class="tag">C#</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/C-CLI/"><span class="tag">C++/CLI</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CLOO/"><span class="tag">CLOO</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/D3DImage/"><span class="tag">D3DImage</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DirectX/"><span class="tag">DirectX</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Extension/"><span class="tag">Extension</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/FFmpeg/"><span class="tag">FFmpeg</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GPU/"><span class="tag">GPU</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Guangzhou/"><span class="tag">Guangzhou</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/LayeredWindow/"><span class="tag">LayeredWindow</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Loop-Hoisting/"><span class="tag">Loop Hoisting</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Loop-Invariant-Hoisting/"><span class="tag">Loop Invariant Hoisting</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Mlt-Framework/"><span class="tag">Mlt Framework</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/NET-Standard/"><span class="tag">NET Standard</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Nikon/"><span class="tag">Nikon</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OpenCL/"><span class="tag">OpenCL</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Perforator/"><span class="tag">Perforator</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Performance/"><span class="tag">Performance</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Profiling/"><span class="tag">Profiling</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RyuJIT/"><span class="tag">RyuJIT</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Timelapse/"><span class="tag">Timelapse</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/VSCode/"><span class="tag">VSCode</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Video/"><span class="tag">Video</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Visual-Studio/"><span class="tag">Visual Studio</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Volatile/"><span class="tag">Volatile</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/WPF/"><span class="tag">WPF</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Xcode/"><span class="tag">Xcode</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/async-await/"><span class="tag">async/await</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/design-pattern/"><span class="tag">design pattern</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/filter/"><span class="tag">filter</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/"><span class="tag">内存模型</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8D%95%E5%8F%8D/"><span class="tag">单反</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/"><span class="tag">图像处理</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B0%BE%E9%80%92%E5%BD%92/"><span class="tag">尾递归</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9B%BC%E5%BE%B7%E5%8D%9A%E9%9B%86%E5%90%88/"><span class="tag">曼德博集合</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%B8%B2%E6%9F%93/"><span class="tag">渲染</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BC%96%E8%AF%91%E5%99%A8%E4%BC%98%E5%8C%96/"><span class="tag">编译器优化</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BF%BB%E8%AF%91/"><span class="tag">翻译</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%A7%A3%E7%A0%81/"><span class="tag">解码</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%B0%83%E8%AF%95/"><span class="tag">调试</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%80%9A%E7%94%A8%E8%AE%A1%E7%AE%97/"><span class="tag">通用计算</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/"><span class="tag">音视频</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%AB%98%E6%80%A7%E8%83%BD%E8%AE%A1%E7%AE%97/"><span class="tag">高性能计算</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%AB%98%E6%96%AF%E6%A8%A1%E7%B3%8A/"><span class="tag">高斯模糊</span><span class="tag is-grey-lightest">1</span></a></div></div></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li><li><a class="level is-mobile is-mobile" href="http://lindexi.oschina.io/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">林德熙的博客</span></span><span class="level-right"><span class="level-item tag">lindexi.oschina.io</span></span></a></li><li><a class="level is-mobile is-mobile" href="https://walterlv.github.io/blog/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">吕毅的博客</span></span><span class="level-right"><span class="level-item tag">walterlv.github.io</span></span></a></li></ul></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/gandalf_me.png" alt="gandalfliang的个人博客" height="28"></a><p class="size-small"><span>&copy; 2020 gandalfliang</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'https://gandalfliang.github.io',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>